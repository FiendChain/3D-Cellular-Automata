{"version":3,"sources":["simulation/worker.js","ui/reducers/gui.js","ui/actions/index.js","ui/components/Controls.jsx","app/Camera.js","simulation/CellularAutomaton3D.js","gl/Texture3D.js","gl/Texture2D.js","app/rendering/SimulationRenderer.js","app/rendering/ColourMaps.js","gl/Shader.js","gl/VertexBuffer.js","gl/IndexBuffer.js","gl/Uniform.js","app/rendering/shaders/border.js","gl/CubeData.js","app/rendering/BoundingBox.js","ui/util/AdjustableValues.js","app/rendering/Border.js","app/rendering/renderers/Renderer.js","app/rendering/shaders/volume.js","app/rendering/renderers/VolumeRenderer.js","app/rendering/shaders/fragment_shader.js","app/rendering/shaders/vertex_shader.js","app/rendering/renderers/PointCloudRenderer.js","app/rendering/renderers/VoxelRenderer.js","app/rendering/ShaderManager.js","simulation/Serialised.js","app/RuleReader.js","app/entry_browser/Entry.js","app/entry_browser/DefaultEntryBrowser.js","app/entry_browser/StoredEntryBrowser.js","app/entry_browser/EntryBrowser.js","app/Statistics.js","app/RandomiserManager.js","app/App.js","ui/components/SimulationView/MouseController.js","ui/components/SimulationView/TouchScreenController.js","ui/components/SimulationView/Canvas.jsx","ui/reducers/index.js","ui/reducers/randomiser_manager.js","ui/reducers/statistics.js","ui/reducers/shader_manager.js","ui/reducers/entry_manager.js","ui/reducers/app.js","ui/components/SimulationView/FullScreenButton.jsx","ui/components/SimulationView/SimulationView.jsx","ui/components/EntryBrowser/EntryEditor.jsx","ui/components/EntryBrowser/Entry.jsx","ui/components/EntryBrowser/AddButton.jsx","ui/components/EntryBrowser/EntryBrowser.jsx","ui/util/Help.jsx","ui/util/ColorPicker.jsx","ui/util/AdjustableValueViews.jsx","ui/components/BorderControls.jsx","ui/components/ShaderMenu.jsx","ui/components/SizeChanger.jsx","ui/components/Statistics.jsx","ui/components/Randomiser.jsx","App.jsx","serviceWorker.js","index.jsx"],"names":["module","exports","Worker","gui_reducer","init","default_settings","fullscreen","focused","settings","action","type","value","sim","Controls","is_running","useSelector","state","app","dispatch","useDispatch","on_off","run_btn","className","onClick","Camera","this","fov","aspect_ratio","view_position","vec3","fromValues","look_position","create","target","model_translation","model","mat4","view","projection","update","identity","translate","scale","lookAt","perspective","Math","PI","dx","dy","rotation","rotateY","xz_plane_direction","sub","rotate","transformMat4","delta","diff","add","CellularAutomaton3D","stats","worker","promise_id","addEventListener","event","msg","data","error","console","recieve","notify","grid","local","ev","message","listeners","Set","listener","set_grid","delete","size","use_worker","rule","randomiser","stop","start","transferables","id","postMessage","Texture3D","gl","shape","texture","createTexture","bindTexture","TEXTURE_3D","texParameteri","TEXTURE_MAG_FILTER","NEAREST","TEXTURE_MIN_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_WRAP_R","pixelStorei","UNPACK_ALIGNMENT","texImage3D","RG8","RG","UNSIGNED_BYTE","slot","activeTexture","TEXTURE0","Texture2D","TEXTURE_2D","texImage2D","RGBA8","RGBA","range","SimulationRenderer","shader_manager","max_neighbours","data_updated","listen_available_frame","unprocessed_blocks","update_texture_buffer","total_cells","create_textures","state_colour_texture","state_colours_data","Uint8Array","i","total_states","offset","hue","colorsys","hsv_to_rgb","r","g","b","create_states_texture","radius_colour_texture","create_radius_texture","cell_data_width","cell_data","cell_data_texture","items","render_updates","count","cells","neighbours","total_items","performance","now","width","neighbour","floor","min","end","texSubImage3D","bind","request_frame","load_texture_data","on_render","Shader","vertex_shader_src","fragment_shader_src","create_shader_program","uniforms","locations","vertex_shader","createShader","VERTEX_SHADER","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","prepend_line_numbers","Error","fragment_shader","FRAGMENT_SHADER","program","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","create_program","name","uniform","location","getUniformLocation","push","useProgram","length","apply","src","split","map","v","join","VertexBufferObject","usage","vbo","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","VertexArrayObject","vao","createVertexArray","integer_types","INT","UNSIGNED_INT","layout","attributes","attribute","enableVertexAttribArray","index","has","vertexAttribIPointer","is_normalised","stride","vertexAttribPointer","bindVertexArray","VertexBufferLayout","sizeof","VertexBufferAttribute","slice","FLOAT","IndexBuffer","buffer","ELEMENT_ARRAY_BUFFER","STATIC_DRAW","UniformMat4f","uniformMatrix4fv","UniformVec3f","uniform3f","Uniform","callback","cube","vertex_data","left","right","front","back","top","bottom","Float32Array","index_data","Uint32Array","cube_optimized","BoundingBox","thickness","generate","triangle_count","push_data","shifted_index","idx","x","y","z","create_cube","centre","AdjustableValue","help","_value","Toggle","val","Color","color","Slider","max","clamp","Dropdown","options","undefined","Border","camera","colour","adjusted_size","offset_vec","border","shader","border_shader","index_buffer","push_attribute","add_vertex_buffer","add_uniform","loc","c","uniform4f","drawElements","TRIANGLES","Renderer","props","params","key","uniform1i","create_frag_shader","colouring","volume_shader","vert_src","frag_src","xyz","layer","radius","neighbour_and_alive","VolumeRenderer","create_volume_data","ibo","add_params","occlusion","step_factor","create_shader","listen","current_option","add_uniforms","uniform1f","enable","CULL_FACE","n","abs","position","cullFace","FRONT","BACK","basic","point_cloud","basic_alternate","no_shading","inline_imports","create_inline_header","create_inline_footer","PointCloudRenderer","point_type","brightness","scaling_enabled","quad","create_quad_data","tri","create_triangle_data","current_data","drawElementsInstanced","VoxelRenderer","shading_params","ambient_strength","diffuse_strength","specular_strength","specular_power_factor","fog_near","fog_far","sun_strength","sky_strength","light_colour","global_params","shading","Object","keys","shading_keys","update_props","light_position","create_cube_data","load_params","ShaderManager","renderers","volume","point","voxel","renderer_type","values","forEach","renderer","current_renderer","update_params","SerializedRandomiser","SeedCrystalSerialized","density","SeedCrystalAbsoluteSerialized","RuleSerialized","remain","become","NeighbourSerialized","NeighbourRules","RuleReader","string","substrings","replace","remain_alive","become_alive","convert_to_number","retrieve_rule","number_range","N","Array","fill","numbers","number","assert_number","word","isNaN","Number","Entry","ca_string","description","DefaultEntryBrowser","entries","add_entry","select","entry","current_index","selected_entry","StoredEntryBrowser","db_cfg","store","db_request","window","indexedDB","open","onerror","onsuccess","db","result","on_db_load","onupgradeneeded","createObjectStore","keyPath","autoIncrement","createIndex","unique","cfg","transaction","objectStore","corrupted_ids","openCursor","cursor","StoredEntry","ex","continue","purge_corrupted_ids","ids","original","put","Promise","resolve","reject","oncomplete","request","EntryBrowser","browsers","current_browser_key","listen_select","selected_browser","then","err","String","stored","edit","Statistics","completed_blocks","frame_time","total_blocks","total_steps","texture_data_update","texture_data_upload","draw_time","cooldown","setTimeout","recieve_key","recieve_batch","force_update","RandomiserManager","add_randomiser","other","current_randomiser","App","DEPTH_TEST","BLEND","blendFunc","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","show_border","show_render","background_colour","randomiser_manager","entry_browser","sim_renderer","set_size","set_randomiser","to_json","update_randomiser","set_rule","randomise","distance","min_index","list","min_i","min_val","argmin","requestAnimationFrame","loop","on_update","canvas","clientWidth","height","clientHeight","viewport","resize","clearColor","clear","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","MouseController","onMouseDown","on_mouse_down","onMouseUp","on_mouse_up","onMouseMove","on_mouse_move","onWheel","on_wheel","rotating","zooming","mouse_start_pos","vec2","clientX","clientY","curr_pos","delta_zoom","deltaY","zoom","TouchScreenController","onTouchStart","on_touch_start","onTouchMove","on_touch_move","onTouchEnd","on_touch_end","total_touches","touch_start_pos","touch_zoom_distance","touch_list","touches","touch","zoom_touches","calculate_touch_distance","on_touch_rotate","on_touch_zoom","touch_a","touch_b","dist_a","dist_b","first","second","pos_start","pos_end","Canvas","mouse_controller","touch_controller","current","getContext","create_app","focus_timeout","create_focus_timeout","clearTimeout","delay","change_focus","getState","gui","set_focused","reducer","init_stats","init_app","combineReducers","step","toggle","browser","manager","select_renderer","update_current","create_reducer","replaceReducer","run","ref","React","Component","FullScreenButton","font","is_fullscreen","e","document","documentElement","d","request_fullscreen","requestFullscreen","mozRequestFullScreen","webkitRequestFullScreen","msRequestFullscreen","cancel_fullscreen","exitFullscreen","mozCancelFullScreen","webkitCancelFullScreen","msExitFullscreen","set_fullscreen","action_fullscreen","SimulationView","useStore","float_controls","style","zIndex","alignSelf","href","data-toggle","data-placement","title","class","EntryEditor","useState","set_name","set_ca_string","show_actions","set_show_actions","onSubmit","onExit","errors","on_submit","preventDefault","err_fmt","form","onKeyDown","keyCode","onChange","data-html","str","lines","line","render_errors","actions","onMouseOver","role","onMouseEnter","onMouseLeave","editing","set_editing","set_errors","on_error","edit_entry","on_exit","EntryView","selected","onEdit","copy_success","set_copy_success","del","copy","on_delete","delete_entry","on_copy","navigator","permissions","query","res","clipboard","writeText","on_edit","render_copy_button","select_entry","AddButton","create_entry","textAlign","selected_browser_key","selected_index","browser_key","set_browser_key","get_entries","is_user","browser_keys","render_controls","Help","text","ColorPicker","valueChanged","show_picker","set_show_picker","rgba","a","background","rgb","disableAlpha","RenderAdjustableValue","adjustable","slider","toFixed","SliderView","checked","ToggleView","dropdown","option","DropdownView","valueChange","ColorView","BorderControls","border_checkbox","render_checkbox","border_colour","ShaderMenu","card_body","ShaderSettings","aria-expanded","aria-controls","update_shader_params","SizeChanger","app_size","set_x","set_y","set_z","clamped","size_changer_form","X","Y","Z","on_size_change","progress","RandomiserMenu","randomiser_options","select_randomiser","SeedCrystalEditor","param_options","change_param","createStore","compose","applyMiddleware","thunk","createRef","Main","Boolean","hostname","match","ReactDOM","render","getElementById","serviceWorker","ready","registration","unregister","catch"],"mappings":"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","file":"static/js/main.cb5499ea.chunk.js","sourcesContent":["module.exports = function() {\n  return new Worker(__webpack_public_path__ + \"9c903fdfe86c1905cd1c.worker.js\");\n};","export function gui_reducer(init) {\r\n    let default_settings = {\r\n        fullscreen: false, \r\n        focused: true,\r\n        ...init\r\n    };\r\n    const reducer = (settings=default_settings, action) => {\r\n        switch (action.type) {\r\n            case 'gui.fullscreen':\r\n                return {...settings, fullscreen: action.value};\r\n            case 'gui.focused':\r\n                return {...settings, focused: action.value};\r\n            default:\r\n                break;\r\n        }\r\n        return settings;\r\n    }\r\n    return reducer;\r\n}","// app controls\r\nexport const show_render = is_render => ({\r\n    type: 'app.show_render', value: is_render\r\n})\r\n\r\nexport const show_border = has_border => ({\r\n    type: 'app.show_border', value: has_border\r\n})\r\n\r\nexport const set_background_colour = colour => ({\r\n    type: 'app.set_background_colour', value: colour\r\n})\r\n\r\nexport const set_border_colour = colour => ({\r\n    type: 'app.set_border_colour', value: colour\r\n})\r\n\r\nexport const set_size = size => ({\r\n    type: 'app.set_size', value: size\r\n})\r\n\r\n// sim controls\r\nexport const sim = {\r\n    step:       () => ({type: 'step'}),\r\n    randomise:  () => ({type: 'randomise'}),\r\n    clear:      () => ({type: 'clear'}),\r\n    toggle:     () => ({type: 'toggle'}),\r\n    start:      () => ({type: 'start'}),\r\n    stop:       () => ({type: 'stop'}),\r\n}\r\n\r\n// entries\r\nexport const refresh_entries = () => ({\r\n    type: 'entry.refresh'\r\n})\r\n\r\nexport const select_entry = (browser, index) => ({\r\n    type: 'entry.select', value: {key: browser, index}\r\n})\r\n\r\nexport const create_entry = (name, ca_string, on_error) => (dispatch, getState) => {\r\n    let entry_browser = getState().entry_browser;\r\n    entry_browser.create(name, ca_string)\r\n        .then(() => {\r\n            on_error(false);\r\n            dispatch(refresh_entries());\r\n        }, (err) => {\r\n            on_error(err);\r\n        }); \r\n}\r\n\r\nexport const edit_entry = (browser, index, name, ca_string, on_error) => (dispatch, getState) => {\r\n    let entry_browser = getState().entry_browser;\r\n    entry_browser.edit(browser, index, name, ca_string)\r\n        .then(() => {\r\n            on_error(false);\r\n            dispatch(refresh_entries());\r\n        }, (err) => {\r\n            on_error(err);\r\n        });\r\n}\r\n\r\nexport const delete_entry = (browser, index) => (dispatch, getState) => {\r\n    let entry_browser = getState().entry_browser;\r\n    entry_browser.delete(browser, index)\r\n        .then(() => {\r\n            dispatch(refresh_entries());\r\n        })\r\n}\r\n\r\n// randomiser\r\nexport const select_randomiser = index => ({\r\n    type: 'randomiser.select', value: index\r\n})\r\n\r\nexport const update_randomiser = (name, value) => ({\r\n    type: 'randomiser.update', name: name, value: value \r\n})\r\n\r\n// shader\r\nexport const select_renderer = index => ({\r\n    type: 'shader.select_renderer', value: index\r\n})\r\n\r\nexport const update_shader_params = params => ({\r\n    type: 'shader.update_params', value: params\r\n})\r\n\r\n// statistics\r\nexport const update_statistics = stats => ({\r\n    type: 'stats.update', value: stats\r\n})\r\n\r\n// gui\r\nexport const set_fullscreen = fullscreen => ({\r\n    type: 'gui.fullscreen', value: fullscreen\r\n})\r\n\r\nexport const set_focused = focused => ({\r\n    type: 'gui.focused', value: focused\r\n})\r\n","import React from 'react';\r\n\r\nimport { useSelector, useDispatch } from 'react-redux';\r\n\r\nimport { sim } from '../actions';\r\n\r\nexport function Controls () {\r\n  const is_running = useSelector(state => state.app.sim.is_running);\r\n  const dispatch = useDispatch();\r\n\r\n  const on_off = is_running ? 'Pause': 'Run';\r\n  const run_btn = is_running ? 'danger' : 'success';\r\n\r\n  return (\r\n    <div className=\"btn-group\">\r\n      <button className=\"btn btn-secondary\" onClick={() => dispatch(sim.step())}>Step</button>\r\n      <button className=\"btn btn-primary\" onClick={() => dispatch(sim.randomise())}>Randomise</button>\r\n      <button className=\"btn btn-warning\" onClick={() => dispatch(sim.clear())}>Clear</button>\r\n      <button className={\"btn btn-\"+run_btn} onClick={() => dispatch(sim.toggle())}>{on_off}</button>\r\n    </div>\r\n  );\r\n}","import { mat4, vec3 } from 'gl-matrix';\r\n\r\nexport class Camera {\r\n  constructor() {\r\n    this.fov = 50;\r\n    this.aspect_ratio = 1;\r\n    this.view_position = vec3.fromValues(0, 0, 0);\r\n    this.look_position = vec3.create();\r\n    this.target = vec3.fromValues(0, 0, 0);\r\n    this.model_translation = vec3.create();\r\n\r\n    this.model = mat4.create();\r\n    this.view = mat4.create();\r\n    this.projection = mat4.create();\r\n\r\n    this.update();\r\n  }\r\n\r\n  update() {\r\n\r\n    mat4.identity(this.model);\r\n    mat4.translate(this.model, this.model, this.model_translation);\r\n    mat4.scale(this.model, this.model, [1, 1, 1]); \r\n\r\n    mat4.lookAt(this.view, this.view_position, this.target, [0, 1, 0]);\r\n\r\n    // mat4.perspectiveFromFieldOfView(this.projection, fov, 0.01, 1000);\r\n    mat4.perspective(this.projection, this.fov * Math.PI / 180, this.aspect_ratio, 0.01, 10000);\r\n  }\r\n\r\n  rotate(dx, dy) {\r\n    // vec3.rotateX(this.pos, this.pos, this.look_position, -dy);\r\n    // vec3.rotateY(this.pos, this.pos, this.look_position, dx);\r\n\r\n    let rotation = mat4.create();\r\n    mat4.rotateY(rotation, rotation, dx);\r\n\r\n    let xz_plane_direction = vec3.create();\r\n    vec3.sub(xz_plane_direction, this.look_position, this.view_position);\r\n    xz_plane_direction[1] = this.look_position[1];\r\n    vec3.rotateY(xz_plane_direction, xz_plane_direction, this.look_position, Math.PI/2.0);\r\n\r\n    mat4.rotate(rotation, rotation, -dy, xz_plane_direction);\r\n\r\n    // mat4.rotateX(rotation, rotation, -dy);\r\n    vec3.transformMat4(this.view_position, this.view_position, rotation);\r\n  }\r\n\r\n  zoom(delta) {\r\n    let diff = vec3.create();\r\n    vec3.sub(diff, this.view_position, this.look_position);\r\n    vec3.scale(diff, diff, 1.0+delta);\r\n\r\n    vec3.add(this.view_position, this.look_position, diff);\r\n  }\r\n\r\n\r\n}","import worker from 'worker-loader!./worker.js'; // eslint-disable-line import/no-webpack-loader-syntax \r\nimport { Grid3D } from './Grid3D';\r\n\r\n/**\r\n * Frontend to communicate with the web worker\r\n */\r\nexport class CellularAutomaton3D {\r\n    constructor(stats) {\r\n        this.stats = stats;\r\n\r\n        this.worker = worker();\r\n        this.promise_id = 0;\r\n        this.is_running = false;\r\n\r\n        this.worker.addEventListener('message', (event) => {\r\n            let msg = event.data;\r\n\r\n            if (msg.error) {\r\n                // throw msg.error;\r\n                console.error(msg);\r\n                return;\r\n            }\r\n\r\n            switch (msg.action) {\r\n                case 'stats':\r\n                    this.stats.recieve(msg.data);\r\n                    return;\r\n                case 'grid':\r\n                    this.notify(msg.grid, msg.local);\r\n                default:\r\n                    break;\r\n            }\r\n        });\r\n\r\n        this.worker.addEventListener('error', ev => {\r\n            console.error(ev.message, ev);\r\n        })\r\n\r\n        this.listeners = new Set();\r\n    }\r\n\r\n    notify(grid, local) {\r\n        for (let listener of this.listeners) {\r\n            listener(grid, local);\r\n        }\r\n        this.set_grid(grid);\r\n    }\r\n\r\n    listen_available_frame(listener) {\r\n        return this.listeners.add(listener);\r\n    }\r\n\r\n    unlisten_available_frame(listener) {\r\n        return this.listeners.delete(listener);\r\n    }\r\n\r\n    set_size(size) {\r\n        this.use_worker('set_size', size);\r\n    }\r\n\r\n    set_rule(rule) {\r\n        this.use_worker('set_rule', rule);\r\n    }\r\n\r\n    set_randomiser(randomiser) {\r\n        this.use_worker('set_randomiser', randomiser);\r\n    }\r\n\r\n    clear() {\r\n        this.use_worker('clear');\r\n    }\r\n\r\n    randomise() {\r\n        this.use_worker('randomise');\r\n    }\r\n\r\n    step() {\r\n        this.use_worker('step');\r\n    }\r\n\r\n    start() {\r\n        this.use_worker('start');\r\n        this.is_running = true;\r\n    }\r\n\r\n    stop() {\r\n        this.use_worker('stop');\r\n        this.is_running = false;\r\n    }\r\n\r\n    toggle() {\r\n        this.is_running ? this.stop() : this.start();\r\n    }\r\n\r\n    set_grid(grid) {\r\n        this.use_worker('set_grid', grid, grid.transferables);\r\n    }\r\n\r\n    request_frame() {\r\n        this.use_worker('request_frame');\r\n    }\r\n\r\n    use_worker(action, data={}, transferables=[]) {\r\n\r\n        let id = this.promise_id;\r\n        this.promise_id += 1;\r\n\r\n        this.worker.postMessage({action, id, data}, transferables);\r\n    }\r\n};","export class Texture3D {\r\n    constructor(gl, data, shape) {\r\n        this.gl = gl;\r\n        this.data = data;\r\n        this.shape = shape;\r\n        this.texture = gl.createTexture();\r\n\r\n        gl.bindTexture(gl.TEXTURE_3D, this.texture);\r\n        // The R32F type works only with gl.RED and gl.FLOAT\r\n        // https://www.khronos.org/registry/webgl/specs/latest/2.0/#TEXTURE_TYPES_FORMATS_FROM_DOM_ELEMENTS_TABLE\r\n        gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n\r\n        gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_WRAP_R, gl.CLAMP_TO_EDGE);\r\n        gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);\r\n\r\n        // gl.texImage3D(gl.TEXTURE_3D, 0, gl.R8, shape[0], shape[1], shape[2], 0, gl.RED, gl.UNSIGNED_BYTE, this.data);\r\n        // gl.texImage3D(gl.TEXTURE_3D, 0, gl.RG8, shape[0], shape[1], shape[2], 0, gl.RG, gl.UNSIGNED_BYTE, this.data);\r\n        gl.texImage3D(gl.TEXTURE_3D, 0, gl.RG8, shape[0], shape[1], shape[2], 0, gl.RG, gl.UNSIGNED_BYTE, this.data);\r\n        // gl.texImage3D(gl.TEXTURE_3D, 0, gl.RGBA8, shape[0], shape[1], shape[2], 0, gl.RGBA, gl.UNSIGNED_BYTE, this.data);\r\n    }\r\n\r\n    bind(slot=0) {\r\n        let gl = this.gl;\r\n        gl.activeTexture(gl.TEXTURE0 + slot);\r\n        gl.bindTexture(gl.TEXTURE_3D, this.texture);\r\n    }\r\n}","export class Texture2D {\r\n    constructor(gl, data, shape) {\r\n        this.gl = gl;\r\n        this.data = data;\r\n        this.shape = shape;\r\n        this.texture = gl.createTexture();\r\n\r\n        gl.bindTexture(gl.TEXTURE_2D, this.texture);\r\n        // The R32F type works only with gl.RED and gl.FLOAT\r\n        // https://www.khronos.org/registry/webgl/specs/latest/2.0/#TEXTURE_TYPES_FORMATS_FROM_DOM_ELEMENTS_TABLE\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);\r\n        // gl.texImage2D(gl.TEXTURE_2D, 0, gl.R8, shape[0], shape[1], 0, gl.RED, gl.UNSIGNED_BYTE, this.data);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA8, shape[0], shape[1], 0, gl.RGBA, gl.UNSIGNED_BYTE, this.data);\r\n    }\r\n\r\n    bind(slot=0) {\r\n        let gl = this.gl;\r\n        gl.activeTexture(gl.TEXTURE0 + slot);\r\n        gl.bindTexture(gl.TEXTURE_2D, this.texture);\r\n    }\r\n}","import { Texture3D } from '../../gl/Texture3D';\r\nimport { create_states_texture, create_radius_texture } from './ColourMaps';\r\n\r\n/**\r\n * Collect data from simulation and render it\r\n */\r\nexport class SimulationRenderer {\r\n  constructor(gl, sim, shader_manager, stats) {\r\n    this.gl = gl;\r\n\r\n    this.sim = sim;\r\n    this.shader_manager = shader_manager;\r\n    this.stats = stats;\r\n    this.max_neighbours = 26;\r\n\r\n    this.data_updated = false;\r\n\r\n    this.sim.listen_available_frame((grid, unprocessed_blocks, local) => {\r\n      this.update_texture_buffer(grid, unprocessed_blocks, local);\r\n    });\r\n  }\r\n\r\n  set_size(size) {\r\n    this.size = size;\r\n    this.total_cells = size[0] * size[1] * size[2];\r\n    this.create_textures();\r\n  }\r\n\r\n  create_textures() {\r\n    let gl = this.gl;\r\n\r\n    // colour maps for states and distances\r\n    this.state_colour_texture = create_states_texture(gl);\r\n    this.radius_colour_texture = create_radius_texture(gl);\r\n\r\n    // create 3d texture for rendering cell data\r\n    this.cell_data_width = 2;\r\n    this.cell_data = new Uint8Array(this.total_cells*this.cell_data_width);\r\n    this.cell_data_texture = new Texture3D(gl, this.cell_data, this.size);\r\n  }\r\n\r\n  \r\n\r\n  // from the transferred grid from webworker, update the texture's buffer\r\n  // we use a rgba buffer, with 8 bits for each channel\r\n  // r = state, g = neighbours, b/a = unused\r\n  update_texture_buffer(grid, local=false) {\r\n    let gl = this.gl;\r\n\r\n    let items = local ? grid.render_updates : range(0, grid.count);\r\n    // once updates all rendered, clear it\r\n    if (local) grid.render_updates = new Set();\r\n\r\n    let cells = grid.cells;\r\n    let neighbours = grid.neighbours;\r\n\r\n    let total_items = 0;\r\n\r\n    let start = performance.now();\r\n    const width = this.cell_data_width;\r\n    let cell_data = this.cell_data;\r\n    for (let i of items) {\r\n      let offset = i*width;\r\n      let state = cells[i];\r\n      let neighbour = neighbours[i];\r\n      cell_data[offset+0] = state;\r\n      cell_data[offset+1] = Math.floor(Math.min(neighbour, this.max_neighbours)/this.max_neighbours * 255);\r\n      total_items += 1;\r\n    }\r\n    let end = performance.now();\r\n    this.stats.recieve('texture_data_update', end-start);\r\n\r\n    // data mutated if more than one item\r\n    this.data_updated = this.data_updated || (total_items > 0);\r\n  }\r\n\r\n  // open gl requires us to load data to gpu when texture changed\r\n  load_texture_data() {\r\n    let gl = this.gl;\r\n    if (!this.data_updated) {\r\n      return;\r\n    }\r\n    let start = performance.now();\r\n    gl.texSubImage3D(gl.TEXTURE_3D, 0, 0, 0, 0, this.size[0], this.size[1], this.size[2], gl.RG, gl.UNSIGNED_BYTE, this.cell_data, 0);\r\n    let end = performance.now();\r\n    this.stats.recieve('texture_data_upload', end-start);\r\n    this.data_updated = false;\r\n  }\r\n\r\n  // render the 3d grid\r\n  on_render() {\r\n    let gl = this.gl;\r\n\r\n    this.shader_manager.bind();\r\n    this.cell_data_texture.bind(0);\r\n    this.sim.request_frame();\r\n    this.load_texture_data();\r\n    this.state_colour_texture.bind(1);\r\n    this.radius_colour_texture.bind(2);\r\n    {\r\n      let start = performance.now();\r\n      this.shader_manager.on_render();\r\n      let end = performance.now();\r\n      this.stats.recieve('draw_time', end-start);\r\n    }\r\n  }\r\n}\r\n\r\nfunction *range(start, end) {\r\n  for (let i = start; i < end; i++) {\r\n    yield i;\r\n  }\r\n}\r\n\r\n","import { Texture2D } from '../../gl/Texture2D';\r\nimport colorsys from 'colorsys';\r\n\r\nexport function create_states_texture(gl) {\r\n  let total_states = 40;\r\n  let state_colours_data = new Uint8Array(4*total_states)\r\n  for (let i = 0; i < total_states-1; i++) {\r\n    let offset = (i+1)*4;\r\n    \r\n    const hue_range = 200;\r\n    let hue = hue_range*(1.0-i/total_states);\r\n    let saturation = 100;\r\n    let value = 100;\r\n    let {r, g, b} = colorsys.hsv_to_rgb(hue, saturation, value);\r\n    state_colours_data[offset+0] = r;\r\n    state_colours_data[offset+1] = g;\r\n    state_colours_data[offset+2] = b;\r\n    state_colours_data[offset+3] = 255;\r\n  }\r\n\r\n  for (let i = 0; i < 4; i++) {\r\n    state_colours_data[i] = 0;\r\n  }\r\n\r\n  return new Texture2D(gl, state_colours_data, [total_states,1]);\r\n}\r\n\r\nexport function create_radius_texture(gl) {\r\n  let total_states = 360;\r\n  let state_colours_data = new Uint8Array(4*total_states)\r\n  for (let i = 0; i < total_states; i++) {\r\n    let offset = (i)*4;\r\n    \r\n    const hue_range = 360;\r\n    let hue = hue_range*(1.0-i/total_states);\r\n    let saturation = 100;\r\n    let value = 100;\r\n    let {r, g, b} = colorsys.hsv_to_rgb(hue, saturation, value);\r\n    state_colours_data[offset+0] = r;\r\n    state_colours_data[offset+1] = g;\r\n    state_colours_data[offset+2] = b;\r\n    state_colours_data[offset+3] = 255;\r\n  }\r\n  \r\n  return new Texture2D(gl, state_colours_data, [total_states,1]);\r\n}","export class Shader {\r\n  constructor(gl, vertex_shader_src, fragment_shader_src) {\r\n    this.gl = gl;\r\n    this.create_shader_program(vertex_shader_src, fragment_shader_src);\r\n    this.uniforms = []; \r\n    this.locations = [];\r\n  }\r\n\r\n  create_shader_program(vertex_shader_src, fragment_shader_src) {\r\n    [this.vertex_shader, this.fragment_shader, this.program] = create_program(this.gl, vertex_shader_src, fragment_shader_src); \r\n  }\r\n\r\n  // add to list of uniforms permanently binded to shader\r\n  add_uniform(name, uniform) {\r\n    let gl = this.gl;\r\n    let location = gl.getUniformLocation(this.program, name);\r\n    if (location === null) {\r\n      // console.warn(`Couldn't find location of uniform ${name}`);\r\n      // throw new Error(`Couldn't find location of uniform ${name}`);\r\n    } \r\n    this.uniforms.push(uniform);\r\n    this.locations.push(location);\r\n  }\r\n\r\n  // dynamic sub in uniform\r\n  // apply_uniform(name, uniform) {\r\n  //   let gl = this.gl;\r\n  //   this.bind();\r\n  //   let location = gl.getUniformLocation(this.program, name);\r\n  //   uniform.apply(location);\r\n  // }\r\n\r\n  bind() {\r\n    let gl = this.gl;\r\n    gl.useProgram(this.program);\r\n    for (let i = 0; i < this.uniforms.length; i++) {\r\n      let uniform = this.uniforms[i];\r\n      let location = this.locations[i];\r\n      if (location === null) {\r\n        continue;\r\n      }\r\n      uniform.apply(location);\r\n    }\r\n  }\r\n}\r\n\r\nfunction create_program(gl, vertex_shader_src, fragment_shader_src) {\r\n  const vertex_shader = gl.createShader(gl.VERTEX_SHADER);\r\n  gl.shaderSource(vertex_shader, vertex_shader_src);\r\n  gl.compileShader(vertex_shader);\r\n  if (!gl.getShaderParameter(vertex_shader, gl.COMPILE_STATUS)) {\r\n    console.error(gl.getShaderInfoLog(vertex_shader));\r\n    console.error(prepend_line_numbers(vertex_shader_src));\r\n    throw new Error('Unable to compile vertex shader');\r\n  }\r\n\r\n  const fragment_shader = gl.createShader(gl.FRAGMENT_SHADER);\r\n  gl.shaderSource(fragment_shader, fragment_shader_src);\r\n  gl.compileShader(fragment_shader);\r\n  if (!gl.getShaderParameter(fragment_shader, gl.COMPILE_STATUS)) {\r\n    console.error(gl.getShaderInfoLog(fragment_shader));\r\n    console.error(prepend_line_numbers(fragment_shader_src));\r\n    throw new Error('Unable to compile fragment shader');\r\n  }\r\n\r\n  const program = gl.createProgram();\r\n  gl.attachShader(program, vertex_shader);\r\n  gl.attachShader(program, fragment_shader);\r\n  gl.linkProgram(program);\r\n  if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\r\n    console.error(gl.getProgramInfoLog(program));\r\n    throw new Error('Unable to construct shader program');\r\n  }\r\n\r\n  return [vertex_shader, fragment_shader, program];\r\n}\r\n\r\nfunction prepend_line_numbers(src) {\r\n  let lines = src.split('\\n').map((v, i) => `${i+1}\\t| ${v}`);\r\n  let out = lines.join('\\n');\r\n  return out;\r\n}","// 1D array containing n elements\r\n// can contain arbitary data\r\nexport class VertexBufferObject {\r\n  constructor(gl, data, usage) {\r\n    this.gl = gl;\r\n\r\n    this.data = data;\r\n\r\n    this.vbo = gl.createBuffer();\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.vbo);\r\n    gl.bufferData(gl.ARRAY_BUFFER, data, usage);\r\n  }\r\n\r\n  bind() {\r\n    let gl = this.gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.vbo);\r\n  }\r\n}\r\n\r\nexport class VertexArrayObject {\r\n  constructor(gl) {\r\n    this.gl = gl;\r\n    this.vao = gl.createVertexArray();\r\n    this.integer_types = new Set([gl.INT, gl.UNSIGNED_INT]);\r\n  }\r\n\r\n  add_vertex_buffer(vbo, layout) {\r\n    let gl = this.gl;\r\n\r\n    this.bind();\r\n    vbo.bind();\r\n\r\n    let offset = 0;\r\n    for (let attribute of layout.attributes) {\r\n      gl.enableVertexAttribArray(attribute.index);\r\n      if (this.integer_types.has(attribute.type)) {\r\n        gl.vertexAttribIPointer(attribute.index, attribute.count, attribute.type, attribute.is_normalised, layout.stride, offset);\r\n      } else {\r\n        gl.vertexAttribPointer(attribute.index, attribute.count, attribute.type, attribute.is_normalised, layout.stride, offset);\r\n      }\r\n      offset += attribute.count * attribute.size;\r\n    }\r\n  }\r\n\r\n  bind() {\r\n    let gl = this.gl;\r\n    gl.bindVertexArray(this.vao);\r\n  }\r\n}\r\n\r\nexport class VertexBufferLayout {\r\n  constructor(gl) {\r\n    this.gl = gl;\r\n    this.stride = 0;\r\n    this.attributes = [];\r\n  }\r\n\r\n  push_attribute(index, count, type, is_normalised) {\r\n    let size = this.sizeof(type);\r\n    let attribute = new VertexBufferAttribute(index, count, type, is_normalised, size);\r\n    this.attributes.push(attribute);\r\n    this.stride += count * size;\r\n  }\r\n\r\n  slice(start, end) {\r\n    let layout = new VertexBufferLayout();\r\n    layout.stride = this.stride;\r\n    layout.attributes = this.attributes.slice(start, end);\r\n    return layout;\r\n  }\r\n\r\n  sizeof(type) {\r\n    let gl = this.gl;\r\n\r\n    switch (type) {\r\n    case gl.FLOAT: return 4;\r\n    case gl.UNSIGNED_INT: return 4;\r\n    case gl.INT: return 4;\r\n    default: throw new Error(`Unknown element type: ${type}`);\r\n    }\r\n  }\r\n}\r\n\r\n// each element in the shader has an attribute index\r\n// layout(location = <attribute_index>) in vec3 position;\r\n// layout(locaiton = <attribute_index>) in vec3 normal;\r\nclass VertexBufferAttribute {\r\n  constructor(index, count, type, is_normalised, size) {\r\n    this.index = index;\r\n    this.count = count;\r\n    this.type = type;\r\n    this.is_normalised = is_normalised;\r\n    this.size = size;\r\n  }\r\n\r\n  \r\n}","export class IndexBuffer {\r\n    constructor(gl, data) {\r\n        this.gl = gl;\r\n\r\n        this.buffer = gl.createBuffer();\r\n        this.count = data.length;\r\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer); \r\n        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, data, gl.STATIC_DRAW); // gluint is 4 bytes\r\n    }\r\n\r\n    bind() {\r\n        let gl = this.gl;\r\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n    }\r\n}","export class UniformMat4f {\r\n    constructor(gl, data) {\r\n        this.gl = gl;\r\n        this.data = data;\r\n    }\r\n\r\n    apply(location) {\r\n       this.gl.uniformMatrix4fv(location, false, this.data);\r\n    }\r\n}\r\n\r\nexport class UniformVec3f {\r\n    constructor(gl, data) {\r\n        this.gl = gl;\r\n        this.data = data;\r\n    }\r\n\r\n    apply(location) {\r\n        this.gl.uniform3f(location, this.data[0], this.data[1], this.data[2]);\r\n    }\r\n}\r\n\r\nexport class UniformVec4f {\r\n    constructor(gl, data) {\r\n        this.gl = gl;\r\n        this.data = data;\r\n    }\r\n\r\n    apply(location) {\r\n        this.gl.uniform4f(location, this.data[0], this.data[1], this.data[2], this.data[3]);\r\n    }\r\n}\r\n\r\nexport class Uniform {\r\n    constructor(callback) {\r\n        this.callback = callback;\r\n    }\r\n\r\n    apply(location) {\r\n        this.callback(location);\r\n    }\r\n}","const vertex = \r\n`\r\nprecision mediump float;\r\n\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\n\r\nuniform mat4 uModel;\r\nuniform mat4 uView;\r\nuniform mat4 uProjection;\r\nuniform vec3 uOffset;\r\n\r\nvoid main() {\r\n    mat4 MVP = uProjection * uView * uModel;\r\n    gl_Position = MVP * vec4(position + uOffset, 1);\r\n}`;\r\n\r\nconst frag = \r\n`\r\nprecision mediump float;\r\n\r\nuniform vec4 uColour;\r\n\r\nvoid main() {\r\n    gl_FragColor = uColour;\r\n}`;\r\n\r\nexport default {vertex: vertex, frag: frag};","function vertex_data(left, right, front, back, top, bottom) {\r\n  return new Float32Array([\r\n    left, bottom, front, 0, 0, 1,\r\n    right, bottom, front, 0, 0, 1,\r\n    left, top, front, 0, 0, 1,\r\n    right, top, front, 0, 0, 1,\r\n\r\n    left, top, front, 0, 1, 0,\r\n    left, top, back, 0, 1, 0,\r\n    right, top, back, 0, 1, 0,\r\n    right, top, front, 0, 1, 0,\r\n\r\n    right, top, front, 1, 0, 0,\r\n    right, bottom, front, 1, 0, 0,\r\n    right, bottom, back, 1, 0, 0,\r\n    right, top, back, 1, 0, 0,\r\n\r\n    left, top, front, -1, 0, 0,\r\n    left, top, back, -1, 0, 0,\r\n    left, bottom, front, -1, 0, 0,\r\n    left, bottom, back, -1, 0, 0,\r\n\r\n    left, bottom, front, 0, -1, 0,\r\n    left, bottom, back, 0, -1, 0,\r\n    right, bottom, back, 0, -1, 0,\r\n    right, bottom, front, 0, -1, 0,\r\n\r\n    left, top, back, 0, 0, -1,\r\n    right, top, back, 0, 0, -1,\r\n    left, bottom, back, 0, 0, -1,\r\n    right, bottom, back, 0, 0, -1,\r\n  ]);\r\n}\r\n\r\n// wind triangles counter clockwise for culling\r\nconst index_data = new Uint32Array([\r\n    0, 3, 2,\r\n    0, 1, 3,\r\n\r\n    4, 6, 5,\r\n    4, 7, 6,\r\n\r\n    8, 9, 11,\r\n    9, 10, 11,\r\n\r\n    13, 14, 12,\r\n    13, 15, 14,\r\n\r\n    16, 18, 19,\r\n    16, 17, 18,\r\n\r\n    20, 21, 22,\r\n    21, 23, 22,\r\n]);\r\n\r\nexport const cube = {\r\n    vertex_data: vertex_data,\r\n    index_data: index_data\r\n};\r\n\r\nfunction vertex_data_performance(left, right, front, back, top, bottom) {\r\n  return new Float32Array([\r\n    left, bottom, front,\r\n    right, bottom, front,\r\n    left, top, front,\r\n    right, top, front,\r\n    left, bottom, back, \r\n    right, bottom, back, \r\n    left, top, back, \r\n    right, top, back, \r\n  ]);\r\n}\r\n\r\n// wind triangles counter clockwise for culling\r\nconst index_data_performance = new Uint32Array([\r\n  0, 1, 2,\r\n  1, 3, 2,\r\n  2, 3, 6, \r\n  3, 7, 6,\r\n  1, 5, 3, \r\n  5, 7, 3,\r\n  0, 2, 6, \r\n  0, 6, 4, \r\n  4, 1, 0, \r\n  1, 4, 5, \r\n  5, 6, 7, \r\n  5, 4, 6,\r\n]);\r\n\r\nexport const cube_optimized = {\r\n    vertex_data: vertex_data_performance,\r\n    index_data: index_data_performance\r\n};","import { cube } from '../../gl/CubeData';\r\nimport { vec3 } from 'gl-matrix';\r\n\r\nexport class BoundingBox {\r\n    constructor(size, thickness) {\r\n        let [vertex_data, index_data] = this.generate(size, thickness);\r\n        this.size = size;\r\n        this.thickness = thickness;\r\n        this.vertex_data = new Float32Array(vertex_data);\r\n        this.index_data = new Uint32Array(index_data);\r\n    }\r\n\r\n    generate(size, thickness) {\r\n        let vertex_data = [];\r\n        let index_data = [];\r\n        let triangle_count = 0;\r\n        function push_data(data) {\r\n            let [v, i] = data;\r\n            vertex_data.push(...v);\r\n            let shifted_index = i.map(idx => idx+triangle_count);\r\n            index_data.push(...shifted_index);\r\n            triangle_count += 24;\r\n        }\r\n\r\n        // create corner pieces\r\n        let shape = vec3.fromValues(thickness, thickness, thickness);\r\n        for (let x of [0, size[0]]) {\r\n            for (let y of [0, size[1]]) {\r\n                for (let z of [0, size[2]]) {\r\n                    push_data(this.create_cube([x, y, z], shape));\r\n                }\r\n            }\r\n        }\r\n        // create x beams\r\n        shape = vec3.fromValues(size[0]-thickness, thickness, thickness);\r\n        for (let y of [0, size[1]]) {\r\n            for (let z of [0, size[2]]) {\r\n                let x = size[0]/2;\r\n                push_data(this.create_cube([x, y, z], shape));\r\n            }\r\n        }\r\n        // create y beams\r\n        shape = vec3.fromValues(thickness, size[1]-thickness, thickness);\r\n        for (let x of [0, size[0]]) {\r\n            for (let z of [0, size[2]]) {\r\n                let y = size[1]/2;\r\n                push_data(this.create_cube([x, y, z], shape));\r\n            }\r\n        }\r\n        // create z beams\r\n        shape = vec3.fromValues(thickness, thickness, size[2]-thickness);\r\n        for (let x of [0, size[0]]) {\r\n            for (let y of [0, size[1]]) {\r\n                let z = size[2]/2;\r\n                push_data(this.create_cube([x, y, z], shape));\r\n            }\r\n        }\r\n\r\n        return [vertex_data, index_data];\r\n    }\r\n\r\n    create_cube(centre, shape) {\r\n        let left = centre[0] - shape[0]/2;\r\n        let right = centre[0] + shape[0]/2;\r\n        let top = centre[1] + shape[1]/2;\r\n        let bottom = centre[1] - shape[1]/2;\r\n        let front = centre[2] - shape[2]/2;\r\n        let back = centre[2] + shape[2]/2;\r\n        let vertex_data = cube.vertex_data(left, right, front, back, top, bottom);\r\n        let index_data = cube.index_data;\r\n        return [vertex_data, index_data];\r\n    }\r\n};","import { vec3 } from \"gl-matrix\";\r\n\r\nclass AdjustableValue {\r\n  constructor(type, value, help) {\r\n    this.type = type;\r\n    this.help = help;\r\n    this._value = value;\r\n    this.listeners = new Set();\r\n  }\r\n\r\n  set value(value) {\r\n    this._value = value;\r\n    this.notify();\r\n  }\r\n\r\n  get value() {\r\n    return this._value;\r\n  }\r\n\r\n  listen(listener) {\r\n    this.listeners.add(listener);\r\n  }\r\n\r\n  unlisten(listener) {\r\n    this.listeners.delete(listener);\r\n  }\r\n\r\n  notify() {\r\n    for (let listener of this.listeners) {\r\n      listener(this);\r\n    }\r\n  }\r\n}\r\n\r\nexport class Toggle extends AdjustableValue {\r\n  constructor(value, help) {\r\n    super('toggle', value, help);\r\n  }\r\n\r\n  // javascript doesnt extend accessors\r\n  set value(val) {\r\n    super.value = val;\r\n  }\r\n\r\n  get value() {\r\n    return super.value;\r\n  }\r\n}\r\n\r\nexport class Color extends AdjustableValue {\r\n  constructor(color, help) {\r\n    super('color', color, help);\r\n  }\r\n\r\n  set value(val) {\r\n    super.value = vec3.fromValues(val[0], val[1], val[2]);\r\n  }\r\n\r\n  get value() {\r\n    return super.value;\r\n  }\r\n}\r\n\r\nexport class Slider extends AdjustableValue {\r\n  constructor(min, max, value, help) {\r\n    super('slider', value, help);\r\n    this.min = min;\r\n    this.max = max;\r\n  }\r\n\r\n  set value(val) {\r\n    val = this.clamp(val);\r\n    super.value = val;\r\n  }\r\n\r\n  get value() {\r\n    return super.value;\r\n  }\r\n\r\n  clamp(val) {\r\n    if (val < this.min) {\r\n      val = this.min;\r\n    }\r\n    if (val > this.max) {\r\n      val = this.max;\r\n    }\r\n    return val;\r\n  }\r\n}\r\n\r\nexport class Dropdown extends AdjustableValue {\r\n  constructor(options, index=0, help=undefined) {\r\n    super('dropdown', index, help);\r\n    this.options = options;\r\n  }\r\n\r\n  set value(index) {\r\n    index = Math.min(index, this.options.length-1);\r\n    super.value = index;\r\n  }\r\n\r\n  get value() {\r\n    return super.value;\r\n  }\r\n\r\n  get current_option() {\r\n    let option = this.options[this.value];\r\n    return option;\r\n  }\r\n}","import { Shader } from '../../gl/Shader';\r\nimport { VertexBufferObject, VertexArrayObject, VertexBufferLayout } from '../../gl/VertexBuffer';\r\nimport { IndexBuffer } from '../../gl/IndexBuffer';\r\nimport { UniformMat4f, UniformVec3f, UniformVec4f, Uniform } from '../../gl/Uniform';\r\n\r\nimport { vec3, vec4 } from 'gl-matrix';\r\n\r\nimport border_shader from './shaders/border';\r\nimport { BoundingBox } from './BoundingBox';\r\nimport { Color } from '../../ui/util/AdjustableValues';\r\n\r\nexport class Border {\r\n  constructor(gl, size, camera) {\r\n    this.gl = gl;\r\n    this.camera = camera;\r\n    this.colour = new Color([0,0,0], \"Border Colour\");\r\n\r\n    let thickness = 0.2;\r\n    let offset = 0.5;\r\n    let adjusted_size = vec3.create();\r\n    vec3.add(adjusted_size, size, vec3.fromValues(2*offset, 2*offset, 2*offset));\r\n    let offset_vec = vec3.fromValues(-offset, -offset, -offset);\r\n\r\n    this.border = new BoundingBox(adjusted_size, thickness);\r\n\r\n    this.shader = new Shader(gl, border_shader.vertex, border_shader.frag);\r\n    this.vbo = new VertexBufferObject(gl, this.border.vertex_data, gl.STATIC_DRAW);\r\n    this.index_buffer = new IndexBuffer(gl, this.border.index_data);\r\n\r\n    let layout = new VertexBufferLayout(gl);\r\n    layout.push_attribute(0, 3, gl.FLOAT, false);\r\n    layout.push_attribute(1, 3, gl.FLOAT, false);\r\n\r\n    this.vao = new VertexArrayObject(gl);\r\n    this.vao.add_vertex_buffer(this.vbo, layout);\r\n\r\n    this.shader.add_uniform(\"uModel\", new UniformMat4f(gl, this.camera.model));\r\n    this.shader.add_uniform(\"uView\", new UniformMat4f(gl, this.camera.view));\r\n    this.shader.add_uniform(\"uProjection\", new UniformMat4f(gl, this.camera.projection));\r\n    // this.shader.add_uniform(\"uColour\", new UniformVec4f(gl, vec4.fromValues(0, 0, 0, 1)));\r\n    // this.shader.add_uniform(\"uColour\", new UniformVec4f(gl, vec4.fromValues(0, 0, 0, 1)));\r\n    this.shader.add_uniform(\"uColour\", new Uniform(loc => {\r\n      let c = this.colour.value;\r\n      gl.uniform4f(loc, c[0]/255, c[1]/255, c[2]/255, 1.0);\r\n    }));\r\n    this.shader.add_uniform(\"uOffset\", new UniformVec3f(gl, offset_vec));\r\n  }\r\n\r\n  on_render() {\r\n    let gl = this.gl;\r\n    this.shader.bind();\r\n    this.vao.bind();\r\n    this.index_buffer.bind();\r\n\r\n    gl.drawElements(gl.TRIANGLES, this.index_buffer.count, gl.UNSIGNED_INT, 0);\r\n  }\r\n}","import { vec3 } from \"gl-matrix\";\r\nimport { UniformMat4f, UniformVec3f, Uniform } from \"../../../gl/Uniform\";\r\n\r\n/**\r\n * Given a 3D point cloud, render it\r\n */\r\nexport class Renderer {\r\n    constructor(gl, props, params) {\r\n        this.gl = gl;\r\n        this.props = {\r\n            size: vec3.create(),\r\n            ...props};\r\n        this.params = params;\r\n    }\r\n\r\n    // arbitary values\r\n    update_props(props) {\r\n        this.props = {...this.props, ...props};\r\n    } \r\n\r\n    add_params(params) {\r\n        this.params = {...this.params, ...params};\r\n    }\r\n\r\n    // adjustable values\r\n    update_params(params) {\r\n        for (let key in params) {\r\n            let param = this.params[key];\r\n            param.value = params[key];\r\n        }\r\n        this.params = {...this.params};\r\n    }\r\n\r\n    // base uniforms\r\n    add_uniforms(shader) {\r\n        let gl = this.gl;\r\n        // camera data\r\n        shader.add_uniform(\"uModel\", new UniformMat4f(gl, this.props.camera.model));\r\n        shader.add_uniform(\"uView\", new UniformMat4f(gl, this.props.camera.view));\r\n        shader.add_uniform(\"uProjection\", new UniformMat4f(gl, this.props.camera.projection));\r\n        // shader.add_uniform(\"uViewPosition\", new UniformVec3f(gl, this.props.camera.view_position));\r\n        shader.add_uniform(\"uViewPosition\", new Uniform(loc => gl.uniform3f(loc, ...this.props.camera.view_position)));\r\n        shader.add_uniform(\"uGridSize\", new Uniform(loc => gl.uniform3f(loc, this.props.size[0], this.props.size[1], this.props.size[2])));\r\n        // default texture slots\r\n        shader.add_uniform(\"uStateTexture\",         new Uniform(loc => gl.uniform1i(loc, 0)));\r\n        shader.add_uniform(\"uStateColourTexture\",   new Uniform(loc => gl.uniform1i(loc, 1)));\r\n        shader.add_uniform(\"uRadiusColourTexture\",  new Uniform(loc => gl.uniform1i(loc, 2)));\r\n    }\r\n\r\n    bind() {\r\n\r\n    }\r\n\r\n    on_render() {\r\n\r\n    }\r\n}","const vert_shader = (\r\n`#version 300 es\r\n\r\nprecision highp sampler3D;\r\nprecision highp sampler2D;\r\nprecision highp float;\r\n\r\nin vec3 position;\r\n\r\nuniform mat4 uModel;\r\nuniform mat4 uView;\r\nuniform mat4 uProjection;\r\n\r\nuniform vec3 uGridSize;\r\nuniform vec3 uViewPosition;\r\n\r\nout vec3 vPosition;\r\nout vec3 vTexturePosition;\r\n\r\nvoid main() {\r\n    mat4 MVP = uProjection * uView * uModel;\r\n    vec3 vertex_pos = position * uGridSize;\r\n    vec4 pos = MVP * vec4(vertex_pos, 1.0);\r\n    // camera centered around (0,0,0)\r\n    // box has size uGridSize\r\n    vec3 camera_box = abs(uViewPosition);\r\n    vec3 volume_box = abs(uGridSize)/2.0;\r\n\r\n    // determine where to start ray trace if camera is inside the volume\r\n    if (camera_box.x < volume_box.x && camera_box.y < volume_box.y && camera_box.z < volume_box.z) {\r\n        vTexturePosition = uViewPosition/(uGridSize/2.0);\r\n        vTexturePosition += vec3(1.0,1.0,1.0);\r\n        vTexturePosition /= 2.0;\r\n    } else {\r\n        vTexturePosition = position;\r\n    }\r\n\r\n    vPosition = (uModel * vec4(vertex_pos, 1.0)).xyz;\r\n    gl_Position = pos;\r\n}\r\n`\r\n);\r\n\r\nconst create_frag_shader = (colouring) => (\r\n`#version 300 es\r\n\r\nprecision highp sampler3D;\r\nprecision highp sampler2D;\r\nprecision highp float;\r\n\r\nin vec3 vPosition;\r\nin vec3 vTexturePosition;\r\n\r\nuniform vec3 uGridSize;\r\nuniform vec3 uViewPosition;\r\n\r\nuniform sampler3D uStateTexture;\r\nuniform sampler2D uStateColourTexture;\r\nuniform sampler2D uRadiusColourTexture;\r\n\r\nuniform float uOcclusion;\r\nuniform float uStepFactor;\r\n\r\nout vec4 vFragColour;\r\n\r\nvoid main() {\r\n    vec3 view_direction = uViewPosition - vPosition;\r\n    vec3 step_size = normalize(view_direction);\r\n    // vec3 resize = abs(step_size);\r\n    // step_size /= max(resize.x, max(resize.y, resize.z));\r\n    step_size = step_size / uGridSize * uStepFactor;\r\n\r\n    vec3 tex_coords = vTexturePosition;\r\n    while (true) {\r\n        vec4 cell = texture(uStateTexture, tex_coords);\r\n        float state = cell[0];\r\n        float neighbours = cell[1];\r\n        float lighting = 1.0-neighbours*uOcclusion;\r\n        vec4 state_colour = texture(uStateColourTexture, vec2(state, 0.0));\r\n        vec4 neighbour_colour = texture(uStateColourTexture, vec2(neighbours, 0.0));\r\n        ${colouring}\r\n        tex_coords -= step_size;\r\n        if (tex_coords.x < 0.0 || tex_coords.x > 1.0 || \r\n            tex_coords.y < 0.0 || tex_coords.y > 1.0 ||\r\n            tex_coords.z < 0.0 || tex_coords.z > 1.0) \r\n        {\r\n            break;\r\n        }\r\n    }\r\n    vFragColour = vec4(0, 0, 0, 0);\r\n}\r\n`\r\n);\r\n\r\nconst state_colouring = create_frag_shader(\r\n`if (state_colour.a != 0.0) {\r\n    vFragColour = vec4(state_colour.xyz*lighting, state_colour.a);\r\n    return;\r\n}\r\n`\r\n);\r\n\r\nconst xyz_colouring = create_frag_shader(\r\n`if (state_colour.a != 0.0) {\r\n    vFragColour = vec4(tex_coords*lighting, state_colour.a);\r\n    return;\r\n}\r\n`\r\n);\r\n\r\nconst layer_colouring = create_frag_shader(\r\n`if (state_colour.a != 0.0) {\r\n    vec3 distance = tex_coords - vec3(0.5, 0.5, 0.5);\r\n    float radius = length(distance * uGridSize);\r\n    float dist = mod(radius/10.0, 1.0); \r\n    vec4 dist_colour = texture(uRadiusColourTexture, vec2(dist, 0.0));\r\n    vFragColour = vec4(dist_colour.xyz*lighting, state_colour.a);\r\n    return;\r\n}\r\n`\r\n);\r\n\r\nconst radius_colouring = create_frag_shader(\r\n`if (state_colour.a != 0.0) {\r\n    vec3 distance = tex_coords - vec3(0.5, 0.5, 0.5);\r\n    float radius = length(distance * uGridSize);\r\n    float dist = length(distance) * 2.0;\r\n    vec4 dist_colour = texture(uRadiusColourTexture, vec2(dist, 0.0));\r\n    vFragColour = vec4(dist_colour.xyz*lighting, state_colour.a);\r\n    return;\r\n}\r\n`\r\n);\r\n\r\nconst neighbour_colouring = create_frag_shader(\r\n`if (neighbour_colour.a != 0.0) {\r\n    vFragColour = vec4(neighbour_colour.xyz*lighting, neighbour_colour.a);\r\n    return;\r\n}\r\n`\r\n);\r\n\r\nconst neighbour_and_alive_colouring = create_frag_shader(\r\n`float alpha = state_colour.a * neighbour_colour.a;\r\nif (alpha != 0.0) {\r\n    vFragColour = vec4(neighbour_colour.xyz*lighting, alpha);\r\n    return;\r\n}\r\n`\r\n);\r\n\r\n\r\nexport const volume_shader = {\r\n    vert_src: vert_shader,\r\n    frag_src: {\r\n        state: state_colouring,\r\n        xyz: xyz_colouring, \r\n        layer: layer_colouring,\r\n        radius: radius_colouring,\r\n        neighbour: neighbour_colouring,\r\n        neighbour_and_alive: neighbour_and_alive_colouring,\r\n    },\r\n};","import { Renderer } from \"./Renderer\";\r\n\r\nimport { VertexBufferObject, VertexArrayObject, VertexBufferLayout } from '../../../gl/VertexBuffer';\r\nimport { IndexBuffer } from \"../../../gl/IndexBuffer\";\r\nimport { Shader } from \"../../../gl/Shader\";\r\nimport { UniformMat4f, UniformVec3f, Uniform } from \"../../../gl/Uniform\";\r\nimport { cube_optimized } from \"../../../gl/CubeData\";\r\nimport { volume_shader } from \"../shaders/volume\";\r\n\r\nimport { Toggle, Slider, Dropdown } from \"../../../ui/util/AdjustableValues\";\r\n\r\nexport class VolumeRenderer extends Renderer {\r\n    constructor(gl, props, params) {\r\n        super(gl, props, params);\r\n        [this.vao, this.ibo, this.index_data] = create_volume_data(gl);\r\n        this.add_params({\r\n            occlusion: new Slider(0, 1, 0.65, \"Amount that nearby cells darken the center cell\"),\r\n            step_factor: new Slider(0.1, 2, 1, \"Decrease to increase quality of volume render\")\r\n        });\r\n        this.create_shader();\r\n        this.params.colouring.listen(() => {\r\n            this.create_shader();\r\n        })\r\n    }\r\n\r\n    create_shader() {\r\n        let colour = this.params.colouring.current_option;\r\n        let vert_src = volume_shader.vert_src;\r\n        let frag_src = volume_shader.frag_src[colour];\r\n        this.shader = new Shader(this.gl, vert_src, frag_src);\r\n        this.add_uniforms(this.shader);\r\n    }\r\n\r\n    add_uniforms(shader) {\r\n        super.add_uniforms(shader);\r\n        let gl = this.gl;\r\n        shader.add_uniform(\"uOcclusion\", new Uniform(loc => gl.uniform1f(loc, this.params.occlusion.value)));\r\n        shader.add_uniform(\"uStepFactor\", new Uniform(loc => gl.uniform1f(loc, this.params.step_factor.value)));\r\n    }\r\n\r\n    bind() {\r\n        this.shader.bind();\r\n        this.vao.bind();\r\n        this.ibo.bind();\r\n    }\r\n\r\n    on_render() {\r\n        let gl = this.gl;\r\n        gl.enable(gl.CULL_FACE);\r\n        // perform culling check depending on whether camera is inside the viewing box\r\n        let size = this.props.size.map(n => Math.abs(n/2));\r\n        let position = this.props.camera.view_position.map(Math.abs);\r\n        if (position[0] < size[0] && position[1] < size[1] && position[2] < size[2]) {\r\n            gl.cullFace(gl.FRONT);\r\n        } else {\r\n            gl.cullFace(gl.BACK);\r\n        }\r\n\r\n        gl.drawElements(gl.TRIANGLES, this.ibo.count, gl.UNSIGNED_INT, 0);\r\n    }\r\n}\r\n\r\nconst create_volume_data = (gl) => {\r\n  let layout = new VertexBufferLayout(gl);\r\n  layout.push_attribute(0, 3, gl.FLOAT, false);\r\n  \r\n  let vertex_data = cube_optimized.vertex_data(0, 1, 1, 0, 1, 0);\r\n  let index_data = cube_optimized.index_data;\r\n\r\n  let vbo = new VertexBufferObject(gl, vertex_data, gl.STATIC_DRAW);\r\n  let ibo = new IndexBuffer(gl, index_data);\r\n\r\n  let vao = new VertexArrayObject(gl);\r\n  vao.add_vertex_buffer(vbo, layout);\r\n\r\n  return [vao, ibo, index_data];\r\n}","const basic_shading = (point_cloud) =>\r\n`#version 300 es\r\n\r\nprecision highp float;\r\nprecision highp int;\r\n\r\nin vec4 vColour;\r\nin vec3 vFragPos;\r\nin vec3 vNormal;\r\n\r\nout vec4 fragColour;\r\n\r\nstruct Light {\r\n    vec3 position;\r\n    vec3 colour;\r\n};\r\n\r\nuniform Light light;\r\n\r\nuniform vec3 uViewPosition;\r\nuniform float uSpecularPowerFactor;\r\nfloat uSpecularScattering = 0.1;\r\n\r\n// vec3 uSkyTop =  vec3( 0.1, 0.2, 0.8 ) * 0.5;\r\n// vec3 uSkyBottom = vec3( 0.5, 0.8, 1.0 ) * 1.5;\r\n// vec3 uSunColour = vec3(1.0, 1.2, 1.4);\r\n\r\nvec3 uSkyTop =  vec3( 0.8, 0.8, 0.8 ) * 0.5;\r\nvec3 uSkyBottom = vec3( 0.8, 0.8, 0.8 ) * 1.5;\r\n\r\nuniform vec3 uSunColour;\r\n// vec3 uSunColour = vec3(1.0, 1.0, 1.0);\r\n\r\n\r\nfloat uFloorHeight = 0.0;\r\nfloat uAmbientOcclusionStrength = 0.8;\r\nfloat uAmbientOcclusionRange = 100.0;\r\n\r\nuniform float uSkyStrength;\r\nuniform float uSunStrength;\r\n\r\nvec4 uFogColour = vec4(1,1,1,1);\r\nuniform float uFogNear;\r\nuniform float uFogFar;\r\nfloat uFogRange = 1000.0;\r\n\r\nvec3 get_sun_direction() {\r\n    return normalize(vec3(20.0, 40.3, -10.4));\r\n}\r\n\r\nvec3 get_sun_lighting(const vec3 normal) {\r\n    vec3 light_direction = -get_sun_direction();\r\n    float angle = max(dot(normal, -light_direction), 0.0);\r\n    return uSunColour * uSunStrength * angle;\r\n}\r\n\r\nvec3 get_sky_lighting(const vec3 normal) {\r\n    float sky_blend = normal.y * 0.5 + 0.5;\r\n    vec3 sky_light = mix(uSkyBottom, uSkyTop, sky_blend);\r\n    return sky_light * uSkyStrength;  \r\n}\r\n\r\nvec3 get_sky_colour(vec3 view_direction) {\r\n    vec3 sky_colour = mix(uSkyBottom, uSkyTop, max(view_direction.y, 0.0));\r\n    return sky_colour * uSkyStrength;\r\n}\r\n\r\nvec4 apply_ambient_occlusion(const vec4 colour, const vec3 position) {\r\n    float height = (position.y - uFloorHeight) / uAmbientOcclusionRange;\r\n    height = abs(height);\r\n    float occlusion = mix(1.0, 1.0-uAmbientOcclusionStrength, clamp(0.0, 1.0, height));\r\n    return vec4(colour.xyz * occlusion, colour.a);\r\n}\r\n\r\nvec4 apply_fog(const vec4 colour, float distance) {\r\n    float norm_distance = distance / uFogRange;\r\n    float fog_strength = clamp(norm_distance, uFogNear, uFogFar);\r\n    return mix(colour, uFogColour, fog_strength);\r\n}\r\n\r\nvoid main() {\r\n    vec3 normal = normalize(vNormal);\r\n    vec3 view_direction = normalize(uViewPosition - vFragPos);\r\n\r\n    vec3 sky_lighting = get_sky_lighting(normal);\r\n    vec3 sky_colour = get_sky_colour(view_direction);\r\n    vec3 sun_lighting = get_sun_lighting(normal);\r\n    vec3 total_lighting = sky_lighting + sun_lighting + sky_colour;\r\n\r\n    vec4 result = vec4(total_lighting, 1) * vColour; \r\n    // result = apply_ambient_occlusion(result, vFragPos);\r\n\r\n    float distance = length(uViewPosition-vFragPos);\r\n    result = apply_fog(result, distance);\r\n\r\n    fragColour = result;\r\n}`;\r\n\r\nconst basic_shading_alternate = (point_cloud) =>\r\n`#version 300 es\r\n\r\nprecision highp float;\r\nprecision highp int;\r\n\r\nin vec4 vColour;\r\nin vec3 vFragPos;\r\nin vec3 vNormal;\r\n\r\nout vec4 fragColour;\r\n\r\nstruct Light {\r\n    vec3 position;\r\n    vec3 colour;\r\n};\r\n\r\nuniform Light light;\r\n\r\nuniform float uAmbientStrength;\r\nuniform float uDiffuseStrength;\r\nuniform float uSpecularStrength;\r\n\r\nuniform vec3 uViewPosition;\r\nuniform float uSpecularPowerFactor;\r\nfloat uSpecularScattering = 0.1;\r\n\r\nvoid main() {\r\n    vec3 normal = normalize(vNormal);\r\n\r\n    vec3 ambient = uAmbientStrength * light.colour;\r\n\r\n    vec3 light_position = vec3(-uViewPosition.x, uViewPosition.y, -uViewPosition.z);\r\n    vec3 light_direction = normalize(light_position - vFragPos);\r\n\r\n    float diff = max(dot(normal, light_direction), 0.0);\r\n    vec3 diffuse = diff * uDiffuseStrength * light.colour;\r\n\r\n    vec3 view_direction = normalize(uViewPosition - vFragPos);\r\n    vec3 reflect_direction = reflect(-light_direction, normal);\r\n    float spec = dot(view_direction, reflect_direction);\r\n    spec = clamp(spec + uSpecularScattering, 0.0, 1.0);\r\n    spec = pow(spec, uSpecularPowerFactor);\r\n    vec3 specular = uSpecularStrength * spec * light.colour;\r\n    \r\n    vec3 total_lighting = (ambient + diffuse + specular) * vColour.xyz;\r\n    vec4 result = vec4(total_lighting, 1.0);\r\n\r\n    fragColour = result;\r\n}`;\r\n\r\nconst create_no_shader = (point_cloud) => (\r\n`#version 300 es\r\n\r\nprecision highp float;\r\nprecision highp int;\r\n\r\nuniform float uBrightness;\r\n\r\nin vec4 vColour;\r\n${point_cloud ? '' : 'in vec3 vNormal;'}\r\n${point_cloud ? '' : 'in vec3 vFragPos;'}\r\n\r\nout vec4 fragColour;\r\n\r\nvoid main() {\r\n    fragColour = vec4(vColour.xyz * uBrightness, vColour.a);\r\n}`);\r\n\r\nexport const fragment_shader_src = {\r\n    basic: basic_shading,\r\n    basic_alternate: basic_shading_alternate,\r\n    no_shading: create_no_shader\r\n}","const calculate_offset = (\r\n`vec3 calculate_offset(int index) {\r\n    float remain = float(index);\r\n    float z = floor(remain/(uGridSize.x*uGridSize.y));\r\n    remain = remain - z*uGridSize.x*uGridSize.y;\r\n    float y = floor(remain/uGridSize.x);\r\n    float x = remain - y*uGridSize.x; \r\n    return vec3(x, y, z);\r\n}`);\r\n\r\nconst calculate_point_cloud = (\r\n`mat3 Rx(float a) {\r\n    return mat3(\r\n        1., 0., 0.,\r\n        0., cos(a), sin(a),\r\n        0., -sin(a), cos(a)\r\n    );\r\n}\r\n\r\nmat3 Ry(float a) {\r\n    return mat3(\r\n        cos(a), 0., -sin(a),\r\n        0, 1., 0.,\r\n        sin(a), 0., cos(a)\r\n    );\r\n}\r\n\r\nvec3 calculate_point_cloud(const vec3 pos, const vec3 offset) {\r\n    vec3 point_position = offset+uCenter-(uGridSize/2.0);\r\n    vec3 view_direction = uViewPosition-point_position;\r\n    vec2 xz = vec2(view_direction.x, view_direction.z);\r\n    float r = length(xz);\r\n    float ay = atan(view_direction.x, view_direction.z);\r\n    float ax = -atan(view_direction.y, r);\r\n    mat3 R = Ry(ay) * Rx(ax);\r\n    return R*(pos-uCenter) + uCenter + offset; \r\n}`\r\n);\r\n\r\nconst get_cell_data = (\r\n`\r\nvec4 get_cell_data(vec3 offset) {\r\n    vec3 vol_tex_coords = offset / uGridSize;\r\n    vec4 cell = texture(uStateTexture, vol_tex_coords);\r\n    return cell;\r\n}\r\n`\r\n);\r\n\r\nconst calculate_scaling = (\r\n`\r\nvec3 scale_position(float scale, vec3 pos) {\r\n    float K = max(scale, float(1-uScalingEnabled));\r\n    vec3 delta = pos-uCenter;\r\n    return uCenter + (K*delta);\r\n}\r\n`\r\n);\r\n\r\nconst inline_imports = (\r\n`\r\n${calculate_offset}\r\n${calculate_scaling}\r\n${calculate_point_cloud}\r\n${get_cell_data}\r\n`\r\n);\r\n\r\nconst create_inline_snippet = (point_cloud) => (\r\n`\r\n// get basic info about cell\r\nvec3 offset = calculate_offset(gl_InstanceID);\r\nvec4 cell = get_cell_data(offset);\r\nfloat state = cell[0];\r\nfloat neighbours = cell[1];\r\nfloat lighting = 1.0-(neighbours*uOcclusion);\r\nvec4 state_colour =  texture(uStateColourTexture, vec2(state,0));\r\n`\r\n);\r\n\r\nconst create_inline_header = (point_cloud) => (\r\n`#version 300 es\r\n\r\nprecision highp float;\r\nprecision highp sampler3D;\r\nprecision highp sampler2D;\r\nprecision highp int;\r\n\r\nin vec3 position;\r\n${point_cloud ? '' : 'in vec3 normal;'}\r\n\r\n// MVP\r\nuniform mat4 uModel;\r\nuniform mat4 uView;\r\nuniform mat4 uProjection;\r\nuniform vec3 uViewPosition;\r\nuniform vec3 uGridSize;\r\n// params\r\nuniform int uScalingEnabled;\r\nuniform float uOcclusion;\r\n// texturing\r\nuniform sampler2D uStateColourTexture;\r\nuniform sampler2D uRadiusColourTexture;\r\nuniform sampler3D uStateTexture;\r\n\r\nvec3 uCenter = vec3(0.5, 0.5, 0.5);\r\n\r\nout vec4 vColour;\r\n${point_cloud ? '' : 'out vec3 vNormal;'}\r\n${point_cloud ? '' : 'out vec3 vFragPos;'}\r\n\r\n${inline_imports}\r\n`\r\n)\r\n\r\nconst create_inline_footer = (point_cloud) => (\r\n`\r\n${point_cloud ? \r\n    'vPosition = calculate_point_cloud(vPosition, offset);' : \r\n    'vPosition = vPosition + offset;'}\r\n\r\n// pass through data\r\nvPosition *= vColour.a;\r\nmat4 MVP = uProjection * uView * uModel;\r\n${point_cloud ? '' : 'vNormal = normal;'}\r\n${point_cloud ? '' : 'vFragPos = vec3(uModel * vec4(vPosition, 1.0));'}\r\ngl_Position = MVP * vec4(vPosition, 1.0);\r\n`\r\n);\r\n\r\nconst create_state_shader = (point_cloud) => (\r\n`${create_inline_header(point_cloud)}\r\nvoid main() {\r\n    ${create_inline_snippet(point_cloud)}\r\n    vec3 vPosition = scale_position(state, position);\r\n    vColour = vec4(state_colour.xyz*lighting, state_colour.a);\r\n    ${create_inline_footer(point_cloud)}\r\n}`);\r\n\r\nconst create_xyz_shading = (point_cloud) => (\r\n`${create_inline_header(point_cloud)}\r\nvoid main() {\r\n    ${create_inline_snippet(point_cloud)}\r\n    vec3 vPosition = scale_position(state, position);\r\n    vec3 xyz_colour = offset / uGridSize;\r\n    vColour = vec4(xyz_colour*lighting, state_colour.a);\r\n    ${create_inline_footer(point_cloud)}\r\n}\r\n`);\r\n\r\nconst create_layer_shading = (point_cloud) => (\r\n`${create_inline_header(point_cloud)}\r\nvoid main() {\r\n    ${create_inline_snippet(point_cloud)}\r\n    vec3 vPosition = scale_position(state, position);\r\n    vec3 distance = offset - (uGridSize/2.0);\r\n    float dist = length(distance/10.0);\r\n    dist = mod(dist, 1.0);\r\n    vec4 dist_colour = texture(uRadiusColourTexture, vec2(dist, 0.0));\r\n    vColour = vec4(dist_colour.xyz*lighting, state_colour.a);\r\n    ${create_inline_footer(point_cloud)}\r\n}`);\r\n\r\nconst create_radius_shading = (point_cloud) => (\r\n`${create_inline_header(point_cloud)}\r\nvoid main() {\r\n    ${create_inline_snippet(point_cloud)}\r\n    vec3 xyz_center = uGridSize/2.0;\r\n    vec3 distance = offset-xyz_center;\r\n    float radius = length(distance/xyz_center);\r\n    float total_repeats = 1.0;\r\n    radius = clamp(radius, 0.0, 1.0) * total_repeats;\r\n    vec4 radius_colour = texture(uRadiusColourTexture, vec2(radius, 0.0));\r\n\r\n    vec3 vPosition = scale_position(state, position);\r\n    vColour = vec4(radius_colour.xyz*lighting, state_colour.a);\r\n    ${create_inline_footer(point_cloud)}\r\n}`);\r\n\r\nconst create_neighbour_shading = (point_cloud) => (\r\n`${create_inline_header(point_cloud)}\r\nvoid main() {\r\n    ${create_inline_snippet(point_cloud)}\r\n    vec4 neighbour_colour = texture(uStateColourTexture, vec2(neighbours, 0.0));\r\n\r\n    vec3 vPosition = scale_position(neighbours, position);\r\n    vColour = vec4(neighbour_colour.xyz*lighting, neighbour_colour.a);\r\n    ${create_inline_footer(point_cloud)}\r\n}`);\r\n\r\nconst create_neighbour_and_alive_shading = (point_cloud) => (\r\n`${create_inline_header(point_cloud)}\r\nvoid main() {\r\n    ${create_inline_snippet(point_cloud)}\r\n    vec4 neighbour_colour = texture(uStateColourTexture, vec2(neighbours, 0.0));\r\n\r\n    vec3 vPosition = scale_position(neighbours, position);\r\n    vColour = vec4(neighbour_colour.xyz*lighting, state_colour.a*neighbour_colour.a);\r\n    ${create_inline_footer(point_cloud)}\r\n}`);\r\n\r\n\r\nexport const vertex_shader_src = {\r\n    state: create_state_shader,\r\n    xyz: create_xyz_shading,\r\n    layer: create_layer_shading,\r\n    radius: create_radius_shading,\r\n    neighbour: create_neighbour_shading,\r\n    neighbour_and_alive: create_neighbour_and_alive_shading,\r\n};","import { Renderer } from \"./Renderer\";\r\n\r\nimport { VertexBufferObject, VertexArrayObject, VertexBufferLayout } from '../../../gl/VertexBuffer';\r\nimport { Shader } from \"../../../gl/Shader\";\r\nimport { IndexBuffer } from \"../../../gl/IndexBuffer\";\r\n\r\nimport { Dropdown, Slider, Toggle } from \"../../../ui/util/AdjustableValues\";\r\nimport { Uniform } from \"../../../gl/Uniform\";\r\n\r\nimport { fragment_shader_src } from \"../shaders/fragment_shader\";\r\nimport { vertex_shader_src } from \"../shaders/vertex_shader\";\r\n\r\nexport class PointCloudRenderer extends Renderer {\r\n    constructor(gl, props, params) {\r\n        super(gl, props, params);\r\n        this.add_params({\r\n            point_type: new Dropdown(['quad', 'tri'], 0, \"Render quad or triangle for each point\"),\r\n            brightness: new Slider(0, 1, 1, \"Global brightness\"),\r\n            occlusion: new Slider(0, 1, 0.65, \"Amount nearby cells darken the center cell\"),\r\n            scaling_enabled: new Toggle(0, \"Size of cell varies with its value\"),\r\n        });\r\n        this.data = {\r\n            quad: create_quad_data(gl),\r\n            tri: create_triangle_data(gl),\r\n        };\r\n        this.create_shader();\r\n        this.params.colouring.listen(colouring => {\r\n            this.create_shader();\r\n        });\r\n    }\r\n\r\n    create_shader() {\r\n        let colour = this.params.colouring.current_option;\r\n        let vert_src = vertex_shader_src[colour](true);\r\n        let frag_src = fragment_shader_src.no_shading(true);\r\n        this.shader = new Shader(this.gl, vert_src, frag_src);\r\n        this.add_uniforms(this.shader);\r\n    }\r\n\r\n    add_uniforms(shader) {\r\n        super.add_uniforms(shader);\r\n        let gl = this.gl;\r\n        shader.add_uniform(\"uBrightness\", new Uniform(loc => gl.uniform1f(loc, this.params.brightness.value)));\r\n        shader.add_uniform(\"uOcclusion\", new Uniform(loc => gl.uniform1f(loc, this.params.occlusion.value)));\r\n        shader.add_uniform(\"uScalingEnabled\", new Uniform(loc => gl.uniform1i(loc, this.params.scaling_enabled.value)));\r\n    }\r\n\r\n    get current_data() {\r\n        return this.data[this.params.point_type.current_option];\r\n    }\r\n\r\n    bind() {\r\n        this.shader.bind();\r\n        let data = this.current_data;\r\n        data.vao.bind();\r\n        data.ibo.bind();\r\n    }\r\n\r\n    on_render() {\r\n        let gl = this.gl;\r\n        let data = this.current_data;\r\n        let size = this.props.size;\r\n        let total_cells = size[0]*size[1]*size[2];\r\n        gl.enable(gl.CULL_FACE);\r\n        gl.cullFace(gl.BACK);\r\n        gl.drawElementsInstanced(gl.TRIANGLES, data.ibo.count, gl.UNSIGNED_INT, data.index_data, total_cells); \r\n    }\r\n}\r\n\r\n// square for each point\r\nconst create_quad_data = (gl) => {\r\n    let layout = new VertexBufferLayout(gl);\r\n    layout.push_attribute(0, 3, gl.FLOAT, false);\r\n\r\n    let vertex_data = new Float32Array([0, 1, 0.5,\r\n                                        1, 1, 0.5,\r\n                                        0, 0, 0.5,\r\n                                        1, 0, 0.5]);\r\n    let index_data = new Uint32Array([2, 1, 0, 2, 3, 1]);\r\n\r\n    let vbo = new VertexBufferObject(gl, vertex_data, gl.STATIC_DRAW);\r\n    let ibo = new IndexBuffer(gl, index_data);\r\n\r\n    let vao = new VertexArrayObject(gl);\r\n    vao.add_vertex_buffer(vbo, layout);\r\n    return {vao: vao, ibo: ibo, index_data: index_data};\r\n}\r\n\r\n// triangle for each point\r\nconst create_triangle_data = (gl) => {\r\n    let layout = new VertexBufferLayout(gl);\r\n    layout.push_attribute(0, 3, gl.FLOAT, false);\r\n\r\n    let vertex_data = new Float32Array([-0.5, -0.5, 0.5,\r\n                                        1.5, -0.5, 0.5,\r\n                                        0.5, -1.5, 0.5]);\r\n    let index_data = new Uint32Array([2, 1, 0]);\r\n\r\n    let vbo = new VertexBufferObject(gl, vertex_data, gl.STATIC_DRAW);\r\n    let ibo = new IndexBuffer(gl, index_data);\r\n\r\n    let vao = new VertexArrayObject(gl);\r\n    vao.add_vertex_buffer(vbo, layout);\r\n    return {vao: vao, ibo: ibo, index_data: index_data};\r\n}","import { Renderer } from \"./Renderer\";\r\n\r\nimport { VertexBufferObject, VertexArrayObject, VertexBufferLayout } from '../../../gl/VertexBuffer';\r\nimport { Shader } from \"../../../gl/Shader\";\r\nimport { UniformMat4f, UniformVec3f, Uniform } from \"../../../gl/Uniform\";\r\nimport { IndexBuffer } from \"../../../gl/IndexBuffer\";\r\nimport { cube } from \"../../../gl/CubeData\";\r\n\r\nimport { Toggle, Slider, Dropdown, Color } from \"../../../ui/util/AdjustableValues\";\r\nimport { fragment_shader_src } from \"../shaders/fragment_shader\";\r\nimport { vertex_shader_src } from \"../shaders/vertex_shader\";\r\n\r\nimport { vec3 } from \"gl-matrix\";\r\n\r\n\r\nexport class VoxelRenderer extends Renderer {\r\n    constructor(gl, props, params) {\r\n        super(gl, props, {});\r\n        this.shading_params = {\r\n            ambient_strength: new Slider(0, 1, 0.4, \"Amount of global lighting\"),\r\n            diffuse_strength: new Slider(0, 1, 0.95, \"Amount of light scattering\"),\r\n            specular_strength: new Slider(0, 1, 0.6, \"Amount of light reflection\"),\r\n            specular_power_factor: new Slider(0, 128.0, 4.0, \"Strength of the light reflection\"),\r\n            scaling_enabled: new Toggle(0, \"Change size of cell depending on its value (state or total neighbours)\"),\r\n            fog_near: new Slider(0, 1, 0, \"Minimum distance of fog\"),\r\n            fog_far: new Slider(0, 1, 0, \"Maximum distance of fog\"),\r\n            sun_strength: new Slider(0, 1, 0.95, \"Strength of the sun\"),\r\n            sky_strength: new Slider(0, 1, 0.25, \"Strength of sky lighting\"),\r\n            brightness: new Slider(0, 1, 1.0, \"Amount of global lighting\"),\r\n            occlusion: new Slider(0, 1, 0.0, \"Amount nearby cells darken the center cell\"),\r\n            light_colour: new Color(vec3.fromValues(255, 255, 255), \"Colour of sun\"),\r\n        };\r\n\r\n        this.global_params = {\r\n            ...params,\r\n            shading: new Dropdown(Object.keys(fragment_shader_src), 0, \"Different methods of rendering\"),\r\n        };\r\n\r\n        this.shading_keys = {\r\n          basic: ['occlusion', 'sun_strength', 'sky_strength', 'fog_near', 'fog_far', 'light_colour', 'scaling_enabled'],\r\n          basic_alternate: ['occlusion', 'ambient_strength', 'diffuse_strength', 'specular_strength', 'specular_power_factor', 'light_colour', 'scaling_enabled'],\r\n          no_shading: ['occlusion', 'brightness', 'scaling_enabled']\r\n        };\r\n\r\n        this.update_props({\r\n            light_position: vec3.create()\r\n        });\r\n        [this.vao, this.ibo, this.index_data] = create_cube_data(gl);\r\n        this.create_shader();\r\n        this.params.colouring.listen(() => this.create_shader());\r\n        this.params.shading.listen(() => this.create_shader());\r\n    }\r\n\r\n    create_shader() {\r\n        this.load_params();\r\n        let colour = this.global_params.colouring.current_option;\r\n        let shading = this.global_params.shading.current_option;\r\n        let vert_src = vertex_shader_src[colour](false);\r\n        let frag_src = fragment_shader_src[shading](false);\r\n        this.shader = new Shader(this.gl, vert_src, frag_src);\r\n        this.add_uniforms(this.shader);\r\n    }\r\n\r\n    // depending on shading type, we get different parameters to configure\r\n    load_params() {\r\n        let params = {};\r\n        let shading = this.global_params.shading.current_option;\r\n        let keys = this.shading_keys[shading];\r\n        for (let key of keys) {\r\n            params[key] = this.shading_params[key];\r\n        }\r\n        this.params = {...this.global_params, ...params};\r\n    }\r\n\r\n    add_uniforms(shader) {\r\n        super.add_uniforms(shader);\r\n        let gl = this.gl;\r\n        // lighting\r\n        shader.add_uniform('light.position', new UniformVec3f(gl, this.props.light_position));\r\n        shader.add_uniform('light.colour', new Uniform(loc => {\r\n            let c = this.shading_params.light_colour.value;\r\n            gl.uniform3f(loc, c[0]/255, c[1]/255, c[2]/255);\r\n        }));\r\n        shader.add_uniform('uSunColour', new Uniform(loc => {\r\n            let c = this.shading_params.light_colour.value;\r\n            gl.uniform3f(loc, c[0]/255, c[1]/255, c[2]/255);\r\n        }))\r\n        // // lighting params\r\n        shader.add_uniform(\"uAmbientStrength\", new Uniform(loc => gl.uniform1f(loc, this.params.ambient_strength.value)));\r\n        shader.add_uniform(\"uDiffuseStrength\", new Uniform(loc => gl.uniform1f(loc, this.params.diffuse_strength.value)));\r\n        shader.add_uniform(\"uSpecularStrength\", new Uniform(loc => gl.uniform1f(loc, this.params.specular_strength.value)));\r\n        shader.add_uniform(\"uSpecularPowerFactor\", new Uniform(loc => gl.uniform1f(loc, this.params.specular_power_factor.value)));\r\n        shader.add_uniform(\"uBrightness\", new Uniform(loc => gl.uniform1f(loc, this.params.brightness.value)));\r\n        shader.add_uniform(\"uOcclusion\", new Uniform(loc => gl.uniform1f(loc, this.params.occlusion.value)));\r\n        // post processing\r\n        shader.add_uniform(\"uScalingEnabled\", new Uniform(loc => gl.uniform1i(loc, this.params.scaling_enabled.value)));\r\n        shader.add_uniform(\"uFogNear\", new Uniform(loc => gl.uniform1f(loc, this.params.fog_near.value)));\r\n        shader.add_uniform(\"uFogFar\", new Uniform(loc => gl.uniform1f(loc, this.params.fog_far.value)));\r\n        shader.add_uniform(\"uSunStrength\", new Uniform(loc => gl.uniform1f(loc, this.params.sun_strength.value)));\r\n        shader.add_uniform(\"uSkyStrength\", new Uniform(loc => gl.uniform1f(loc, this.params.sky_strength.value)));\r\n    }\r\n\r\n    bind() {\r\n        this.shader.bind();\r\n        this.vao.bind();\r\n        this.ibo.bind();\r\n    }\r\n\r\n    on_render() {\r\n        let gl = this.gl;\r\n        let size = this.props.size;\r\n        let total_cells = size[0]*size[1]*size[2];\r\n        gl.enable(gl.CULL_FACE);\r\n        gl.cullFace(gl.BACK);\r\n        gl.drawElementsInstanced(gl.TRIANGLES, this.ibo.count, gl.UNSIGNED_INT, this.index_data, total_cells); \r\n    }\r\n}\r\n\r\nconst create_cube_data = (gl) => {\r\n  let layout = new VertexBufferLayout(gl);\r\n  layout.push_attribute(0, 3, gl.FLOAT, false);\r\n  layout.push_attribute(1, 3, gl.FLOAT, false);\r\n\r\n  let vertex_data = cube.vertex_data(0, 1, 1, 0, 1, 0);\r\n  let index_data = cube.index_data;\r\n\r\n  let vbo = new VertexBufferObject(gl, vertex_data, gl.STATIC_DRAW);\r\n  let ibo = new IndexBuffer(gl, index_data);\r\n\r\n  let vao = new VertexArrayObject(gl);\r\n  vao.add_vertex_buffer(vbo, layout);\r\n\r\n  return [vao, ibo, index_data];\r\n}","import { vec3 } from 'gl-matrix';\r\n\r\nimport { Dropdown } from '../../ui/util/AdjustableValues';\r\nimport { VolumeRenderer } from './renderers/VolumeRenderer';\r\nimport { PointCloudRenderer } from './renderers/PointCloudRenderer';\r\nimport { VoxelRenderer } from './renderers/VoxelRenderer';\r\nimport { vertex_shader_src } from './shaders/vertex_shader';\r\n\r\nexport class ShaderManager {\r\n  constructor(gl, camera) {\r\n    this.gl = gl;\r\n    this.size = vec3.create();\r\n    this.camera = camera;\r\n\r\n    let props = {\r\n      size: this.size,\r\n      camera: this.camera\r\n    };\r\n\r\n    this.global_params = {\r\n      colouring: new Dropdown(Object.keys(vertex_shader_src), 0, 'Method of colouring each cell'),\r\n    };\r\n\r\n    this.renderers = {\r\n      volume: new VolumeRenderer(gl, props, this.global_params),\r\n      point: new PointCloudRenderer(gl, props, this.global_params),\r\n      voxel: new VoxelRenderer(gl, props, this.global_params),\r\n    };\r\n\r\n    {\r\n      const tooltip = (\r\n        \"Method of rendering the grid\\n\"+\r\n        \"Volume: Fastest but low quality (Uses raycasting)\\n\"+\r\n        \"Point: Represents each cell as a floating quad\\n\"+\r\n        \"Voxel: Slowest but highest quality (Like Minecraft)\\n\"\r\n      );\r\n      this.renderer_type = new Dropdown(Object.keys(this.renderers), 0, tooltip);\r\n    }\r\n  }\r\n\r\n  set_size(size) {\r\n    this.size = size;\r\n    Object.values(this.renderers).forEach(renderer => {\r\n      renderer.update_props({size: size});\r\n    })\r\n  }\r\n\r\n  get current_renderer() {\r\n    let key = this.renderer_type.current_option;\r\n    return this.renderers[key];\r\n  }\r\n\r\n  select_renderer(index) {\r\n    this.renderer_type.value = index;\r\n  }\r\n\r\n  get params() {\r\n    return this.current_renderer.params;\r\n  }\r\n\r\n  update_params(params) {\r\n    this.current_renderer.update_params(params);\r\n  }\r\n\r\n  bind() {\r\n    this.current_renderer.bind();\r\n  }\r\n\r\n  on_render() {\r\n    this.current_renderer.on_render();\r\n  }\r\n\r\n\r\n}\r\n","import  { Slider } from '../ui/util/AdjustableValues';\r\n/**\r\n * Serialisation for web worker\r\n */\r\n\r\n\r\nclass SerializedRandomiser {\r\n    constructor(type, params) {\r\n        this.type = type;\r\n        this.params = params;\r\n    }\r\n\r\n    to_json() {\r\n        let params = {};\r\n        for (let key in this.params) {\r\n            params[key] = this.params[key].value;\r\n        }\r\n        return {\r\n            type: this.type,\r\n            params: params \r\n        };\r\n    }\r\n}\r\n\r\nexport class SeedCrystalSerialized extends SerializedRandomiser {\r\n    constructor(density=0.2, radius=0.1) {\r\n        super('Seed Crystal', {\r\n            density: new Slider(0, 1, density, \"Amount of region to fill\"),\r\n            radius: new Slider(0, 0.5, radius, \"Radius of cube to fill (Relative to size of 3D grid)\"),\r\n        });\r\n    }\r\n}\r\n\r\nexport class SeedCrystalAbsoluteSerialized extends SerializedRandomiser {\r\n    constructor(density=0.2, radius=3) {\r\n        super('Seed Crystal Absolute', {\r\n            density: new Slider(0, 1, density, \"Amount of region to fill\"),\r\n            radius: new Slider(0, 100, radius, \"Radius of cube to fill (Number of cells for radius)\"),\r\n        });\r\n    }\r\n}\r\n\r\nexport class RuleSerialized {\r\n    constructor(remain, become, total_states, neighbour) {\r\n        this.remain = remain;\r\n        this.become = become;\r\n        this.total_states = total_states;\r\n        this.neighbour = neighbour;\r\n    }\r\n\r\n    to_json() {\r\n        return this;\r\n    }\r\n}\r\n\r\nexport class NeighbourSerialized {\r\n    constructor(type, max) {\r\n        this.type = type;\r\n        this.max = max;\r\n    }\r\n    \r\n    to_json() {\r\n        return this;\r\n    }\r\n}","import { RuleSerialized, NeighbourSerialized } from \"../simulation/Serialised\";\r\n\r\nconst NeighbourRules = {\r\n  'M': new NeighbourSerialized('M', 26),\r\n  'VN': new NeighbourSerialized('VN', 6),\r\n};\r\n\r\nexport class RuleReader {\r\n  generate(string) {\r\n    string = string.replace(' ', '');\r\n    let substrings = string.split('/');\r\n    if (substrings.length !== 4) {\r\n      throw new Error(`Expected Range/Range/Number/(VN or M).\\nEg: 0,1-4,5/0-26/5/VN`);\r\n    }\r\n    let [remain_alive, become_alive, total_states, neighbour] = substrings;\r\n\r\n\r\n    if (NeighbourRules[neighbour] === undefined) {\r\n      throw new Error(`Invalid neighbourhood. Expected M or VN.`);\r\n    }\r\n\r\n    total_states = this.convert_to_number(total_states);\r\n    if (total_states <= 1) {\r\n      throw new Error(`Invalid total states. Expected 2 or more states`);\r\n    }\r\n\r\n\r\n    neighbour = NeighbourRules[neighbour];\r\n    let remain = this.retrieve_rule(remain_alive);\r\n    let become = this.retrieve_rule(become_alive);\r\n\r\n    return new RuleSerialized(remain, become, total_states, neighbour);\r\n  }\r\n\r\n  retrieve_rule(number_range) {\r\n    let N = new Array(27); \r\n    N.fill(false, 0, -1);\r\n\r\n    let numbers = number_range.split(',');\r\n    for (let number of numbers) {\r\n      // invalid empty number\r\n      if (number.length === 0) {\r\n        throw new Error(`Invalid number, cannot be ''`);\r\n      }\r\n      // If starts with - in front, then not valid\r\n      if (number[0] === '-') {\r\n        throw new Error(`Range must have number in front: ${number}\\nEg. 0-26`);\r\n      }\r\n      // If it ends with -, then not valid\r\n      if (number[number.length-1] === '-') {\r\n        throw new Error(`Range must have number at back: ${number}\\nEg. 0-26`);\r\n      }\r\n      // Check if all are numbers\r\n      let range = number.split('-').map(n => this.convert_to_number(n));\r\n      if (range.length === 1) {\r\n        let n = range[0];\r\n        this.assert_number(n);\r\n\r\n        N[n] = true;\r\n      } else if (range.length === 2) {\r\n        let [start, end] = range;\r\n        if (end < start) {\r\n          throw new Error(`Invalid range: ${start}-${end}. Must be ordered.`);\r\n        }\r\n        for (let n = start; n <= end; n++) {\r\n          this.assert_number(n);\r\n          N[n] = true;\r\n        }\r\n      } else {\r\n        throw new Error(`Too many numbers in range: ${number_range}. Must be 1 or 2`);\r\n      }\r\n    }\r\n\r\n    return N;\r\n  }\r\n\r\n  convert_to_number(word) {\r\n    if (isNaN(word)) {\r\n      throw new Error(`${word} is not a valid number`);\r\n    }\r\n    return Number(word);\r\n  }\r\n\r\n  // 3**3 - 1 = 26 possible neighbours, 27 possible values 0-26\r\n  assert_number(n) {\r\n    if (n < 0 || n > 26) {\r\n      throw new Error(`Invalid number: ${n}. Must be between 0 to 26`);\r\n    }\r\n  }\r\n}","import { RuleReader } from \"../RuleReader\";\r\n\r\nexport class Entry {\r\n  constructor(name, ca_string, randomiser) {\r\n    this.name = name;\r\n    this.description = ca_string;\r\n    let reader = new RuleReader();\r\n    let rule = reader.generate(ca_string);\r\n    this.rule = rule;\r\n    this.randomiser = randomiser;\r\n  }\r\n}\r\n\r\n","import { SeedCrystalSerialized, SeedCrystalAbsoluteSerialized } from \"../../simulation/Serialised\";\r\nimport { Entry } from \"./Entry\";\r\n\r\nexport class DefaultEntryBrowser {\r\n  constructor() {\r\n    this.entries = [];\r\n    this.listeners = new Set();\r\n    // our default entries\r\n    this.add_entry(new Entry('Amoeba-1',  '9-26/5-7,12-13,15/16/M', new SeedCrystalAbsoluteSerialized(0.3, 5)));\r\n    this.add_entry(new Entry('445',       '4/4/5/M',                new SeedCrystalSerialized(0.05, 0.5)));\r\n    this.add_entry(new Entry('Builder 2', '6,9/4,6,8-9/10/M',       new SeedCrystalAbsoluteSerialized(0.35, 7)));\r\n    this.add_entry(new Entry('Crystal Growth 1', '0-6/1,3/2/VN',    new SeedCrystalAbsoluteSerialized(1.0, 1)));\r\n    this.add_entry(new Entry('Crystal Growth 2', '1-3/1-3/5/VN',    new SeedCrystalAbsoluteSerialized(1.0, 1)));\r\n    this.add_entry(new Entry('Clouds 1',  '13-26/13-14,17-19/2/M',  new SeedCrystalSerialized(0.5, 0.5)));\r\n    this.add_entry(new Entry('Slow Decay', '8,11,13-26/13-26/5/M',  new SeedCrystalSerialized(0.45, 1.0)));\r\n    this.add_entry(new Entry('Spiky Growth 1', '7-26/4,12-13,15/10/M', new SeedCrystalAbsoluteSerialized(0.32, 7)));\r\n    this.add_entry(new Entry('Ripple Cube', '8-26/4,12-13,15/10/M', new SeedCrystalAbsoluteSerialized(0.35, 14)));\r\n    this.add_entry(new Entry('Amoeba-2',  '9-26/5-7,12-13,15/5/M',  new SeedCrystalAbsoluteSerialized(0.3, 5)));\r\n    this.add_entry(new Entry('Builder 1', '6,9/4,6,8-9/10/M',       new SeedCrystalAbsoluteSerialized(0.35, 7)));\r\n    this.add_entry(new Entry('Pyroclastic', '4-7/6-8/10/M',         new SeedCrystalAbsoluteSerialized(0.2, 5)));\r\n    this.add_entry(new Entry('678 678',   '6-8/6-8/3/M',            new SeedCrystalSerialized(0.3)));\r\n\r\n    this.select(0);\r\n  }\r\n\r\n  listen_select(listener) {\r\n    this.listeners.add(listener);\r\n  }\r\n\r\n  notify(entry) {\r\n    for (let listener of this.listeners) {\r\n      listener(entry);\r\n    }\r\n  }\r\n\r\n  get selected_entry() {\r\n    return this.entries[this.current_index];\r\n  }\r\n\r\n  select(idx) {\r\n    this.current_index = idx;\r\n    let entry = this.selected_entry;\r\n    this.notify(entry);\r\n  }\r\n\r\n  add_entry(entry) {\r\n    this.entries.push(entry);\r\n  }\r\n}","import { Entry } from \"./Entry\";\r\n\r\nexport class StoredEntryBrowser {\r\n  constructor() {\r\n    this.entries = [];\r\n\r\n    this.listeners = new Set();\r\n\r\n    this.db_cfg = {\r\n      name: 'entries_db',\r\n      store: 'entries_os'\r\n    };\r\n\r\n    let db_request = window.indexedDB.open(this.db_cfg.name, 1);\r\n    db_request.onerror = (ev) => console.error(`${this.db_cfg.name} failed to open`);\r\n    db_request.onsuccess = (ev) => {\r\n      this.db = db_request.result;\r\n      this.on_db_load();\r\n    };\r\n\r\n    db_request.onupgradeneeded = (ev) => {\r\n      let db = ev.target.result;\r\n      let store = db.createObjectStore(this.db_cfg.store, { keyPath:'id', autoIncrement: true});\r\n      store.createIndex('name', 'name', {unique: false});\r\n      store.createIndex('ca_string', 'ca_string', {unique: false});\r\n    }\r\n\r\n    this.current_index = -1;\r\n  }\r\n\r\n  listen_select(listener) {\r\n    this.listeners.add(listener);\r\n  }\r\n\r\n  notify(entry) {\r\n    for (let listener of this.listeners) {\r\n      listener(entry);\r\n    }\r\n  }\r\n\r\n  on_db_load() {\r\n    // this.add_user_entry('Test', '0-6/1,3/2/VN');\r\n    let cfg = this.db_cfg;\r\n    let store = this.db.transaction(cfg.store).objectStore(cfg.store);\r\n    let corrupted_ids = [];\r\n    store.openCursor().onsuccess = (ev) => {\r\n      let cursor = ev.target.result;\r\n      if (cursor) {\r\n        let {name, ca_string, id} = cursor.value;\r\n        try {\r\n          let entry = new StoredEntry(name, ca_string, id);\r\n          this.add_entry(entry);\r\n        } catch (ex) {\r\n          corrupted_ids.push(id);\r\n        }\r\n        cursor.continue();\r\n        return;\r\n      }      \r\n      // end of cursor list, this lets remove all corrupted ids\r\n      this.purge_corrupted_ids(corrupted_ids);\r\n    }\r\n  }\r\n\r\n  purge_corrupted_ids(ids) {\r\n    let cfg = this.db_cfg;\r\n    let store = this.db.transaction([cfg.store], 'readwrite').objectStore(cfg.store);\r\n    for (let id of ids) {\r\n      let request = store.delete(id);\r\n    }\r\n  }\r\n\r\n  edit(index, name, ca_string) {\r\n    let original = this.entries[index];\r\n    if (!original) return;\r\n\r\n    let replace = new StoredEntry(name, ca_string, original.id);\r\n\r\n    let db = this.db;\r\n    if (!db) {\r\n      console.error(`${cfg.store} failed to load`);\r\n      return;\r\n    } \r\n    let cfg = this.db_cfg;\r\n\r\n    let data = {id: original.id, name, ca_string};\r\n    let transaction = db.transaction([cfg.store], 'readwrite');\r\n    let store = transaction.objectStore(cfg.store);\r\n    let request = store.put(data);\r\n\r\n    let promise = new Promise((resolve, reject) => {\r\n      transaction.oncomplete = (ev) => {\r\n        this.entries[index] = replace;\r\n        this.entries = [...this.entries];\r\n        if (this.current_index === index) {\r\n          this.notify(replace);\r\n        }\r\n        resolve(true);\r\n      }\r\n      transaction.onerror = () => {\r\n        console.error(`Failed to update entry: ${original} to ${replace}`);\r\n        reject(`Failed to update entry: ${original} to ${replace}`);\r\n      }\r\n    });\r\n    return promise;\r\n  }\r\n\r\n  create(name, ca_string) {\r\n    // id is undefined, add in later\r\n    let entry = new StoredEntry(name, ca_string);\r\n\r\n    let db = this.db;\r\n    let cfg = this.db_cfg;\r\n    if (!db) {\r\n      console.error(`${cfg.store} failed to load`);\r\n      return;\r\n    }\r\n    let data = {name, ca_string};\r\n    let transaction = db.transaction([cfg.store], 'readwrite');\r\n    let store = transaction.objectStore(cfg.store);\r\n    let request = store.add(data);\r\n\r\n    return new Promise((resolve, reject) => {\r\n      request.onsuccess = (ev) => {\r\n        let id = ev.target.result;\r\n        entry.id = id;\r\n        this.add_entry(entry);\r\n        resolve(true);\r\n      }\r\n      request.onerror = () => {\r\n        console.error(`Failed to add entry: ${name}, ${ca_string}`);\r\n        reject(`Failed to add entry: ${name}, ${ca_string}`);\r\n      }\r\n    });\r\n }\r\n\r\n  delete(idx) {\r\n    // ignore invalid index\r\n    if (idx < 0 || idx >= this.entries.length) return;\r\n    // map expected current index after removal\r\n    let current_index = this.current_index;\r\n    // if same item, then we want the index to point to same location in list after change\r\n    // this will be the next item\r\n    if (this.current_index === idx) {\r\n      current_index = this.current_index;\r\n    // if an item behind selected item, then we want to keep the selected item\r\n    // this will be now an index behind\r\n    } else if (this.current_index > idx) {\r\n      current_index = this.current_index-1; \r\n    // if selected item behind deleted item, then dont do anything\r\n    } else {\r\n      current_index = this.current_index;\r\n    }\r\n    // remove from db\r\n    let entry = this.entries[idx];\r\n    let cfg = this.db_cfg;\r\n    let transaction = this.db.transaction([cfg.store], 'readwrite');\r\n    let store = transaction.objectStore(cfg.store);\r\n    let request = store.delete(entry.id);\r\n\r\n    // if request was successful, then modify entries array inplace\r\n    // send notification\r\n    return new Promise((resolve, reject) => {\r\n      transaction.oncomplete = () => {\r\n        let entries = this.entries;\r\n        this.entries = [...entries.slice(0, idx), ...entries.slice(idx + 1)];\r\n        // always try to figure out a viable selection before defaulting to nothing\r\n        current_index = Math.max(current_index, 0);\r\n        current_index = Math.min(current_index, this.entries.length-1);\r\n        // if no entries left, then undefined entry\r\n        if (this.entries.length === 0) {\r\n          current_index = -1;\r\n        }\r\n        this.select(current_index);\r\n        resolve(true);\r\n      }\r\n    });\r\n  }\r\n\r\n  get selected_entry() {\r\n    return this.entries[this.current_index];\r\n  }\r\n\r\n  select(idx) {\r\n    this.current_index = idx;\r\n    if (this.current_index < 0 || this.current_index >= this.entries.length) {\r\n      this.notify(undefined);\r\n      return;\r\n    }\r\n    let entry = this.selected_entry;\r\n    this.notify(entry);\r\n  }\r\n\r\n  add_entry(entry) {\r\n    this.entries = [...this.entries, entry]; \r\n  }\r\n}\r\n\r\nclass StoredEntry extends Entry {\r\n  constructor(name, ca_string, id) {\r\n    super(name, ca_string);\r\n    this.id = id;\r\n  }\r\n}","import { DefaultEntryBrowser } from './DefaultEntryBrowser';\r\nimport { StoredEntryBrowser } from './StoredEntryBrowser';\r\n\r\nexport class EntryBrowser {\r\n  constructor() {\r\n    this.listeners = new Set();\r\n\r\n    this.browsers = {\r\n      'Default': new DefaultEntryBrowser(),\r\n      'User': new StoredEntryBrowser(),\r\n    };\r\n\r\n    this.current_browser_key = 'System';\r\n\r\n    this.browsers['Default'].listen_select((entry) => {\r\n      this.notify(entry);\r\n    })\r\n\r\n    this.browsers['User'].listen_select((entry) => {\r\n      if (entry === undefined) {\r\n        this.select('Default', 0);  \r\n      } else {\r\n        this.notify(entry);\r\n      }\r\n    })\r\n  }\r\n\r\n  listen_select(listener) {\r\n    this.listeners.add(listener);\r\n  }\r\n\r\n  notify(entry) {\r\n    for (let listener of this.listeners) {\r\n      listener(entry);\r\n    }\r\n  }\r\n\r\n  get selected_entry() {\r\n    let entry = this.selected_browser.selected_entry;\r\n    return entry;\r\n  }\r\n\r\n  get selected_browser() {\r\n    let browser = this.browsers[this.current_browser_key];\r\n    return browser;\r\n  }\r\n\r\n  get_entries(key) {\r\n    return this.browsers[key].entries;\r\n  }\r\n\r\n  select(key, index) {\r\n    this.current_browser_key = key;\r\n    this.selected_browser.select(index);\r\n  }\r\n\r\n  // wrap around stored database\r\n  delete(key, index) {\r\n    return new Promise((resolve, reject) => {\r\n      if (key !== 'User') {\r\n        reject('Can only delete user defined rules');\r\n        return;\r\n      }\r\n      let stored = this.browsers['User'];\r\n      stored.delete(index)\r\n        .then(v => resolve(v), err => reject(err));\r\n    });\r\n  }\r\n\r\n  create(name, ca_string) {\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        let stored = this.browsers['User'];\r\n        stored.create(name, ca_string)\r\n          .then(v => resolve(v), err => reject(err));\r\n      } catch (ex) {\r\n        reject(String(ex.message));\r\n      }\r\n    });\r\n  }\r\n\r\n  edit(key, index, name, ca_string) {\r\n    let stored = this.browsers[key];\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        let promise = stored.edit(index, name, ca_string);\r\n        promise.then((val) => resolve(val), (err) => reject(err));\r\n      } catch (ex) {\r\n        reject(String(ex.message));\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n","import { update_statistics } from \"../ui/actions\";\r\n\r\nexport class Statistics {\r\n    constructor(store) {\r\n        this.store = store;\r\n        this.data = {\r\n            completed_blocks: 0,\r\n            frame_time: 0,\r\n            total_blocks: 0,\r\n            total_steps: 0,\r\n            texture_data_update: 0,\r\n            texture_data_upload: 0,\r\n            draw_time: 0,\r\n        };\r\n        this.cooldown = false;\r\n    }\r\n\r\n    force_update() {\r\n        if (this.cooldown) {\r\n            return;\r\n        }\r\n\r\n        this.store.dispatch((dispatch) => {\r\n            this.cooldown = true;\r\n            setTimeout(() => {\r\n                dispatch(update_statistics(this));\r\n                setTimeout(() => this.cooldown = false, 30);\r\n            }, 0);\r\n        });\r\n    }\r\n\r\n    recieve(key, value=undefined) {\r\n        if (value !== undefined) {\r\n            this.recieve_key(key, value);\r\n        } else {\r\n            this.recieve_batch(key);\r\n        }\r\n    }\r\n\r\n    recieve_key(key, value) {\r\n        this.data[key] = value;\r\n        this.data = {...this.data};\r\n        this.force_update();\r\n    }\r\n\r\n    recieve_batch(data) {\r\n        for (let key in data) {\r\n            let value = data[key];\r\n            this.data[key] = value;\r\n        }\r\n        this.data = {...this.data};\r\n        this.force_update();\r\n    }\r\n\r\n}","import { SeedCrystalSerialized, SeedCrystalAbsoluteSerialized } from \"../simulation/Serialised\";\r\n\r\nexport class RandomiserManager {\r\n    constructor() {\r\n        this.entries = [];\r\n\r\n        this.add_randomiser(new SeedCrystalSerialized());\r\n        this.add_randomiser(new SeedCrystalAbsoluteSerialized());\r\n\r\n        this.current_index = 0;\r\n        this.listeners = new Set();\r\n    }\r\n\r\n    listen_select(listener) {\r\n        this.listeners.add(listener);\r\n    }\r\n\r\n    notify(randomiser) {\r\n        for (let listener of this.listeners) {\r\n            listener(randomiser);\r\n        }\r\n    }\r\n\r\n    add_randomiser(randomiser) {\r\n        this.entries.push(randomiser);\r\n    }\r\n\r\n    update_randomiser(randomiser) {\r\n        let {type, params} = randomiser;\r\n        for (let i = 0; i < this.entries.length; i++) {\r\n            let other = this.entries[i];\r\n            if (other.type !== type) continue;\r\n\r\n            for (let key in params) {\r\n                other.params[key].value = params[key].value;\r\n            }\r\n            other.params = {...other.params};\r\n            this.current_index = i;\r\n            break;\r\n        }\r\n        this.notify(this.current_randomiser);\r\n    }\r\n\r\n    update_current(key, value) {\r\n        let param = this.current_randomiser.params[key];\r\n        param.value = value;\r\n        this.current_randomiser.params = {...this.current_randomiser.params}; // force update react\r\n    }\r\n\r\n    select(index) {\r\n        this.current_index = index;\r\n        this.notify(this.current_randomiser);\r\n    }\r\n\r\n    get current_randomiser() {\r\n        return this.entries[this.current_index];\r\n    } \r\n}","import { Camera } from './Camera';\r\nimport { CellularAutomaton3D } from '../simulation/CellularAutomaton3D';\r\nimport { vec3 } from 'gl-matrix';\r\n\r\nimport { SimulationRenderer } from './rendering/SimulationRenderer';\r\nimport { Border } from './rendering/Border';\r\nimport { ShaderManager } from './rendering/ShaderManager';\r\nimport { EntryBrowser } from './entry_browser/EntryBrowser';\r\nimport { Statistics } from './Statistics';\r\nimport { RandomiserManager } from './RandomiserManager';\r\nimport { Toggle, Color } from '../ui/util/AdjustableValues';\r\n\r\n\r\nexport class App {\r\n  constructor(gl, store) {\r\n    this.gl = gl;\r\n    this.store = store;\r\n\r\n    gl.enable(gl.DEPTH_TEST);\r\n    gl.enable(gl.BLEND);\r\n    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\r\n\r\n    this.show_border = new Toggle(true, \"Show an outlining border\");\r\n    this.show_render = new Toggle(true, \"Show the grid of cells (Disable if you want to see result later)\");\r\n    this.background_colour = new Color([255,255,255], \"Background Colour\");\r\n\r\n    this.camera = new Camera();\r\n\r\n    this.shader_manager = new ShaderManager(gl, this.camera);\r\n    this.randomiser_manager = new RandomiserManager();\r\n    this.entry_browser = new EntryBrowser();\r\n    this.stats = new Statistics(this.store);\r\n\r\n    this.sim = new CellularAutomaton3D(this.stats);\r\n    this.sim_renderer = new SimulationRenderer(gl, this.sim, this.shader_manager, this.stats);\r\n\r\n    let x = 100;\r\n    this.set_size(vec3.fromValues(x, x, x));\r\n\r\n    this.randomiser_manager.listen_select((randomiser) => {\r\n      this.sim.set_randomiser(randomiser.to_json());\r\n    });\r\n\r\n    this.entry_browser.listen_select((entry) => {\r\n      let randomiser = entry.randomiser;\r\n      let rule = entry.rule;\r\n      if (randomiser) {\r\n        this.randomiser_manager.update_randomiser(randomiser);\r\n      }\r\n      if (rule) {\r\n        this.sim.set_rule(rule.to_json());\r\n        this.sim_renderer.max_neighbours = rule.neighbour.max;\r\n      }\r\n    });\r\n\r\n    // select amoeba with layer colouring\r\n    this.entry_browser.select('Default', 0);\r\n    this.shader_manager.update_params({colouring: 0});\r\n    this.randomise();\r\n  }\r\n\r\n  randomise() {\r\n    let randomiser = this.randomiser_manager.current_randomiser;\r\n    this.sim.set_randomiser(randomiser.to_json());\r\n    this.sim.randomise();\r\n  }\r\n\r\n  set_size(size) {\r\n    let gl = this.gl;\r\n    this.size = size;\r\n    this.sim.set_size(size);\r\n    this.sim_renderer.set_size(size);\r\n    this.shader_manager.set_size(size);\r\n\r\n    this.border = new Border(gl, this.size, this.camera);\r\n\r\n    this.camera.model_translation = vec3.create();\r\n    vec3.scale(this.camera.model_translation, this.size, -0.5);\r\n    // zoom along minimum axis\r\n    // zoom by maximum axis\r\n    let distance = Math.max(...size);\r\n    let min_index = argmin([...size]); \r\n\r\n    this.camera.view_position = vec3.create();\r\n    this.camera.view_position[min_index] = distance*1.5;\r\n    // glitchy around y axis due to euler angle rotation, so add offset\r\n    if (min_index === 1) {\r\n      this.camera.view_position[2] = 1;\r\n    }\r\n  }\r\n\r\n  // try render each frame\r\n  run() {\r\n    requestAnimationFrame(this.loop.bind(this));\r\n  }\r\n\r\n  loop() {\r\n    this.on_update();\r\n    this.on_render();\r\n    requestAnimationFrame(this.loop.bind(this));\r\n  }\r\n\r\n  // when resizing the canvas element, we need to update opengl viewport\r\n  resize() {\r\n    let gl = this.gl;\r\n    let canvas = gl.canvas;\r\n\r\n    let width = canvas.clientWidth;\r\n    let height = canvas.clientHeight;\r\n\r\n    if (width === canvas.width && height === canvas.height)\r\n      return;\r\n\r\n    canvas.width = width;\r\n    canvas.height = height;\r\n    gl.viewport(0, 0, width, height);\r\n    this.camera.aspect_ratio = width/height;\r\n  }\r\n\r\n  on_update() {\r\n    this.camera.update();\r\n  }\r\n    \r\n  on_render() {\r\n    let gl = this.gl;\r\n    this.resize();\r\n    \r\n    {\r\n      let c = this.background_colour.value;\r\n      gl.clearColor(c[0]/255, c[1]/255, c[2]/255, 1);\r\n      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\r\n    }\r\n\r\n    if (this.show_border.value) {\r\n      this.border.on_render();\r\n    }\r\n    if (this.show_render.value) {\r\n      this.sim_renderer.on_render();\r\n    }\r\n  }\r\n}\r\n\r\nfunction argmin(list) {\r\n  let min_i = 0;\r\n  let min_val = list[0];\r\n  for (let i = 1; i < list.length; i++) {\r\n    let val = list[i];\r\n    if (val < min_val) {\r\n      min_val = val;\r\n      min_i = i;\r\n    }\r\n  } \r\n  return min_i;\r\n}\r\n\r\n\r\n\r\n","import { vec2 } from 'gl-matrix';\r\n\r\nexport class MouseController {\r\n  constructor(camera) {\r\n    this.camera = camera;\r\n    this.listeners = {\r\n      onMouseDown: ev => this.on_mouse_down(ev),\r\n      onMouseUp: ev => this.on_mouse_up(ev),\r\n      onMouseMove: ev => this.on_mouse_move(ev),\r\n      onWheel: ev => this.on_wheel(ev)\r\n    };\r\n\r\n    this.rotating = false;\r\n    this.zooming = false;\r\n\r\n    this.mouse_start_pos = vec2.create(); \r\n\r\n  }\r\n\r\n  on_mouse_down(ev) {\r\n    this.rotating = true;\r\n    this.mouse_start_pos[0] = ev.clientX;\r\n    this.mouse_start_pos[1] = ev.clientY;\r\n  }\r\n\r\n  on_mouse_up(ev) {\r\n    this.rotating = false;\r\n  }\r\n\r\n  on_mouse_move(ev) {\r\n    if (!this.rotating || !this.mouse_start_pos) return;\r\n    let factor = 5/1000;\r\n    let curr_pos = vec2.fromValues(ev.clientX, ev.clientY);\r\n    let delta = vec2.create();\r\n    vec2.sub(delta, this.mouse_start_pos, curr_pos);\r\n    vec2.scale(delta, delta, factor);\r\n\r\n    this.camera.rotate(delta[0], delta[1]);\r\n    \r\n    this.mouse_start_pos = curr_pos;\r\n  }\r\n\r\n  on_wheel(ev) {\r\n    let delta_zoom = ev.deltaY * 0.001;\r\n    this.camera.zoom(delta_zoom);\r\n    // ev.stopPropagation();\r\n    // ev.preventDefault();\r\n    // find a way to stop scrolling\r\n  }\r\n}","import { vec2 } from 'gl-matrix';\r\n\r\nexport class TouchScreenController {\r\n  constructor(camera) {\r\n    this.camera = camera;\r\n\r\n    this.listeners = {\r\n      onTouchStart: ev => this.on_touch_start(ev), \r\n      onTouchMove: ev => this.on_touch_move(ev),\r\n      onTouchEnd: ev => this.on_touch_end(ev),\r\n    };\r\n\r\n    this.rotating = false;\r\n    this.zooming = false;\r\n\r\n    this.total_touches = 0;\r\n    this.touch_start_pos = vec2.create();\r\n    this.touch_zoom_distance = 0;\r\n    this.touch_list = [];\r\n  }\r\n\r\n  on_touch_start(ev) {\r\n    let touches = ev.touches;\r\n    this.touch_list.push(...touches);\r\n    this.total_touches += touches.length;\r\n    if (this.total_touches === 1) {\r\n      this.rotating = true;\r\n      this.zooming = false;\r\n      let touch = this.touch_list[this.touch_list.length-1];\r\n      this.touch_start_pos = vec2.fromValues(touch.clientX, touch.clientY);\r\n    } else if (this.total_touches >= 2) {\r\n      this.zooming = true;\r\n      this.rotating = false;\r\n      let zoom_touches = this.touch_list.slice(this.touch_list.length-2, this.touch_list.length);\r\n      this.touch_zoom_distance = this.calculate_touch_distance(...zoom_touches);\r\n    }\r\n  }\r\n\r\n  on_touch_end(ev) {\r\n    this.rotating = false;\r\n    this.zooming = false;\r\n    this.touch_list = [];\r\n    this.total_touches = 0;\r\n    // this.touch_list.pop();\r\n    // this.total_touches -= 1;\r\n    if (this.total_touches < 2) {\r\n      this.zooming = false;\r\n    } \r\n    if (this.total_touches < 1) {\r\n      this.rotating = false;\r\n    }\r\n  }\r\n\r\n  on_touch_move(ev) {\r\n    if (!this.rotating && !this.zooming) return;\r\n    if (this.rotating) {\r\n      this.on_touch_rotate(ev);\r\n    } else if (this.zooming) {\r\n      this.on_touch_zoom(ev);\r\n    }\r\n  }\r\n\r\n  on_touch_rotate(ev) {\r\n    let touches = ev.touches;\r\n    if (touches.length < 1) return;\r\n\r\n    let touch = ev.touches[0];\r\n    let factor = 5/1000;\r\n    let curr_pos = vec2.fromValues(touch.clientX, touch.clientY);\r\n    let delta = vec2.create();\r\n    vec2.sub(delta, this.touch_start_pos, curr_pos);\r\n    vec2.scale(delta, delta, factor);\r\n\r\n    this.camera.rotate(delta[0], delta[1]);\r\n    \r\n    this.touch_start_pos = curr_pos;\r\n  }\r\n\r\n  on_touch_zoom(ev) {\r\n    let touches = ev.touches;\r\n    let distance = this.touch_zoom_distance;\r\n    if (touches.length >= 2) {\r\n      distance = this.calculate_touch_distance(touches[0], touches[1]);\r\n    } else {\r\n      // find nearest\r\n      let touch = touches[0];\r\n      let touch_a = this.touch_list[this.touch_list.length-2];\r\n      let touch_b = this.touch_list[this.touch_list.length-1];\r\n      let dist_a = this.calculate_touch_distance(touch_a, touch);\r\n      let dist_b = this.calculate_touch_distance(touch_b, touch);\r\n\r\n      // update touch a\r\n      if (dist_a < dist_b) {\r\n        this.touch_list[this.touch_list.length-2] = touch;\r\n        distance = dist_b;\r\n      } else {\r\n        this.touch_list[this.touch_list.length-1] = touch;\r\n        distance = dist_a;\r\n      }\r\n      \r\n    }\r\n    let scale = distance / this.touch_zoom_distance;\r\n    this.touch_zoom_distance = distance;\r\n    this.camera.zoom(1.0-scale);\r\n  }\r\n\r\n  calculate_touch_distance(first, second) {\r\n    let pos_start = vec2.fromValues(first.clientX, first.clientY);\r\n    let pos_end = vec2.fromValues(second.clientX, second.clientY);\r\n    let delta = vec2.create();\r\n    vec2.sub(delta, pos_start, pos_end);\r\n    let length = vec2.length(delta);\r\n    return length;\r\n  }\r\n}","import React from 'react';\r\nimport { App } from '../../../app/App';\r\n\r\nimport { MouseController } from './MouseController';\r\nimport { TouchScreenController } from './TouchScreenController';\r\n\r\nimport { create_reducer } from '../../reducers';\r\n\r\nimport \"./Canvas.css\";\r\nimport { set_focused } from '../../actions';\r\n\r\nexport class Canvas extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.mouse_controller = new MouseController();\r\n    this.touch_controller = new TouchScreenController();\r\n  }\r\n\r\n  componentDidMount() {\r\n    let canvas = this.props.canvas.current;\r\n    const gl = canvas.getContext('webgl2');\r\n    if (!gl) {\r\n      throw new Error('WebGL not supported');\r\n    }\r\n    let app = this.create_app(gl);\r\n    let camera = app.camera;\r\n    this.mouse_controller.camera = camera;\r\n    this.touch_controller.camera = camera;\r\n    this.focus_timeout = this.create_focus_timeout();\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    clearTimeout(this.focus_timeout);\r\n  }\r\n\r\n  create_focus_timeout(delay=3000) {\r\n    let id = setTimeout(() => this.change_focus(false), delay);\r\n    return id;\r\n  }\r\n\r\n  // mouse moves, update focus\r\n  on_mouse_move() {\r\n    clearTimeout(this.focus_timeout);\r\n    this.focus_timeout = this.create_focus_timeout();\r\n    this.change_focus(true);\r\n  }\r\n\r\n  change_focus(focused) {\r\n    let store = this.props.store;\r\n    let original = store.getState().gui.focused;\r\n    if (original === focused) {\r\n      return;\r\n    }\r\n    store.dispatch(set_focused(focused));\r\n  }\r\n\r\n  create_app(gl) {\r\n    let store = this.props.store;\r\n    let app = store.getState().app;\r\n    if (app) {\r\n      return app;\r\n    }\r\n\r\n    app = new App(gl, store);\r\n    let reducer = create_reducer(app);\r\n    store.replaceReducer(reducer);\r\n    app.run();\r\n    return app;\r\n  }\r\n\r\n  render() {\r\n    const listener = ev => this.on_mouse_move();\r\n    const hooks = ['onMouseMove', 'onMouseDown', 'onMouseUp', 'onTouchMove', 'onTouchStart', 'onTouchEnd'];\r\n    let listeners = {};\r\n    for (let hook of hooks) {\r\n      listeners[hook] = listener;\r\n    }\r\n    \r\n    return (\r\n      <div className='w-100 h-100' {...listeners}>\r\n        <canvas \r\n          className=\"w-100 h-100\" ref={this.props.canvas} \r\n          {...this.mouse_controller.listeners} {...this.touch_controller.listeners}></canvas>\r\n      </div>\r\n    );\r\n  }\r\n}","import { combineReducers } from 'redux';\r\nimport { app_reducer } from './app';\r\nimport { entry_reducer } from './entry_manager';\r\nimport { shader_reducer } from './shader_manager';\r\nimport { stats_reducer } from './statistics';\r\nimport { randomiser_reducer } from './randomiser_manager';\r\nimport { gui_reducer } from './gui';\r\n\r\nexport function create_reducer(app) {\r\n    let reducers = combineReducers({\r\n      app: app_reducer(app),\r\n      entry_browser: entry_reducer(app.entry_browser),\r\n      shader_manager: shader_reducer(app.shader_manager),\r\n      stats: stats_reducer(app.stats),\r\n      randomiser: randomiser_reducer(app.randomiser_manager),\r\n      gui: gui_reducer(),\r\n    });\r\n\r\n    return reducers;\r\n}\r\n\r\nexport function create_preinit_reducer() {\r\n    return combineReducers({\r\n        gui: gui_reducer()\r\n    })\r\n}\r\n","export function randomiser_reducer(randomiser_manager) {\r\n    const reducer = (manager=randomiser_manager, action) => {\r\n        switch (action.type) {\r\n            case 'randomiser.select':\r\n                manager.select(action.value);\r\n                break;\r\n            case 'randomiser.update':\r\n                manager.update_current(action.name, action.value);\r\n                break;\r\n            default: \r\n                break;\r\n        }\r\n        return manager;\r\n    }\r\n    return reducer;\r\n}","export function stats_reducer(init_stats) {\r\n    const reducer = (stats=init_stats, action) => {\r\n        switch (action.type) {\r\n            case 'stats.update':\r\n                return action.value;\r\n            default: \r\n                break;\r\n        }\r\n\r\n        return stats;\r\n    }\r\n\r\n    return reducer;\r\n}","export function shader_reducer(shader_manager) {\r\n    const reducer = (manager=shader_manager, action) => {\r\n        switch (action.type) {\r\n            case 'shader.select_renderer':\r\n                manager.select_renderer(action.value);\r\n                break;\r\n            case 'shader.update_params':\r\n                manager.update_params(action.value);\r\n                break;\r\n            default: \r\n                break;\r\n        }\r\n\r\n        return manager;\r\n    }\r\n\r\n    return reducer;\r\n}","export function entry_reducer(entry_browser) {\r\n    const reducer = (browser=entry_browser, action) => {\r\n        switch (action.type) {\r\n            case 'entry.refresh':\r\n                return browser;\r\n            case 'entry.select':\r\n                {\r\n                    let {key, index} = action.value;\r\n                    browser.select(key, index);\r\n                }\r\n                break;\r\n            default: \r\n                break;\r\n        }\r\n\r\n        return browser;\r\n    } \r\n\r\n    return reducer;\r\n}","export function app_reducer(init_app) {\r\n    const reducer = (app=init_app, action) => {\r\n        switch (action.type) {\r\n            case 'step': app.sim.step(); break;\r\n            case 'stop': app.sim.stop(); break;\r\n            case 'start': app.sim.start(); break;\r\n            case 'toggle': app.sim.toggle(); break;\r\n            case 'clear': app.sim.clear(); break;\r\n            case 'randomise': app.randomise(); break;\r\n            case 'app.set_size':\r\n                app.set_size(action.value);\r\n                break;\r\n            case 'app.show_border':\r\n                app.show_border.value = action.value;\r\n                break;\r\n            case 'app.show_render':\r\n                app.show_render.value = action.value;\r\n                break;\r\n            case 'app.set_background_colour':\r\n                app.background_colour.value = action.value;\r\n                break;\r\n            case 'app.set_border_colour':\r\n                app.border.colour.value = action.value;\r\n            default: \r\n                break;\r\n            }\r\n\r\n        return app;\r\n    }\r\n\r\n    return reducer;\r\n} \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","import React from 'react';\r\nimport { useSelector, useDispatch } from 'react-redux';\r\n\r\nimport { set_fullscreen as action_fullscreen } from '../../actions';\r\n\r\nexport function FullScreenButton() {\r\n  const dispatch = useDispatch();\r\n  const fullscreen = useSelector(state => state.gui.fullscreen);\r\n\r\n  const font = !fullscreen ? 'arrows-alt' : 'compress-arrows-alt';\r\n\r\n  function set_fullscreen(is_fullscreen) {\r\n    const e = document.documentElement;\r\n    const d = document;\r\n    const request_fullscreen = e.requestFullscreen || e.mozRequestFullScreen || e.webkitRequestFullScreen || e.msRequestFullscreen;\r\n    const cancel_fullscreen = d.exitFullscreen || d.mozCancelFullScreen || d.webkitCancelFullScreen || d.msExitFullscreen;\r\n    if (is_fullscreen) request_fullscreen.bind(e)();\r\n    else               cancel_fullscreen.bind(d)();\r\n  }\r\n\r\n  const onClick = () => {\r\n    let is_fullscreen = !fullscreen;\r\n    set_fullscreen(is_fullscreen);\r\n    dispatch(action_fullscreen(is_fullscreen));\r\n  };\r\n\r\n  return (\r\n    <button className={`btn btn-secondary`} onClick={onClick}>\r\n      <i className={`fas fa-${font} fa-sm`}></i>\r\n    </button>\r\n  );\r\n}","import React, { useState }  from 'react';\r\nimport { Controls } from '../Controls';\r\nimport { useSelector, useStore, useDispatch } from 'react-redux';\r\nimport { Canvas } from './Canvas';\r\nimport { FullScreenButton } from './FullScreenButton';\r\n\r\nexport function SimulationView(props) {\r\n  const dispatch = useDispatch();\r\n  const store = useStore();\r\n  const app = useSelector(store => store.app);\r\n  const fullscreen = useSelector(store => store.gui.fullscreen);\r\n  const focused = useSelector(store => store.gui.focused);\r\n\r\n  let float_controls = (fullscreen && !focused) ? 'fade' : '';\r\n\r\n  function render_float_controls() {\r\n    return (\r\n      <div className={float_controls} style={{zIndex:1, position:'absolute', bottom:'1.5rem', alignSelf:'center'}}>\r\n        <div>\r\n          <Controls></Controls>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  function render_fullscreen_button() {\r\n    return (\r\n      <div className={float_controls} style={{zIndex:2, position:'absolute', top:'1.5rem', right:'1.5rem'}}>\r\n        <FullScreenButton></FullScreenButton>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  function render_links() {\r\n    return (\r\n      <div className={float_controls} style={{zIndex:3, position:'absolute', top:'1.5rem', left:'1.5rem'}}>\r\n        <a className=\"btn btn-dark btn-circle btn-md\" \r\n          href=\"https://github.com/FiendChain/3D-Cellular-Automata\"\r\n          target=\"_blank\"\r\n          data-toggle=\"tooltip\"\r\n          data-placement=\"left\"\r\n          title=\"Github Repository\">\r\n          <i class=\"fab fa-github\"></i>\r\n        </a>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"card shadow h-100\">\r\n      <Canvas store={store} canvas={props.canvas}></Canvas>\r\n      {app ? render_float_controls() : <div></div>}\r\n      {render_fullscreen_button()}\r\n      {render_links()}\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n","import React, { useState } from 'react';\r\nimport \"./Entry.css\";\r\n\r\nexport function EntryEditor(props) {\r\n  const [name, set_name] = useState(props.name || '');\r\n  const [ca_string, set_ca_string] = useState(props.ca_string || '');\r\n  let [show_actions, set_show_actions] = useState(false);\r\n  const onSubmit = props.onSubmit;\r\n  const onExit = props.onExit;\r\n  const errors = props.errors;\r\n\r\n  function on_key_down(ev) {\r\n    if(ev.keyCode === 13) {\r\n      on_submit(ev);\r\n    }\r\n  }\r\n\r\n  function on_submit(ev) {\r\n    if (ev) ev.preventDefault();\r\n    onSubmit && onSubmit(name, ca_string);\r\n  }\r\n\r\n  function on_exit() {\r\n    onExit && onExit();\r\n  }\r\n \r\n  function render_errors(str) {\r\n    let lines = String(str).split('\\n');\r\n    return (\r\n      <div className=\"invalid-feedback\">\r\n        {lines.map((line, i) => <div key={i}>{line}</div>)}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const err_fmt = errors ? 'is-invalid' : '';\r\n\r\n  const tooltip = (\r\n    \"[Remain Alive]/[Become Alive]/[Total States]/[Neighbourhood]\\n\"+\r\n    \"[Remain Alive]: Range where a cell stays alive. E.g. 0-3,9\\n\"+\r\n    \"[Become Alive]: Range where a cell goes from dead to alive. E.g. 0-3,9\\n\"+\r\n    \"[Total States]: Number of states a cell goes through when dying. E.g. 10\\n\"+\r\n    \"[Neighbourhood]: Type of neighbour counting. 'M' counts all 26, and 'VN' counts 6\"\r\n  )\r\n\r\n  const form = (\r\n    <form onSubmit={on_submit} onKeyDown={on_key_down} className=\"w-75\">\r\n      <div className=\"form-group row mb-0 mt-0\">\r\n        <label className=\"col-sm-3 col-form-label py-0\">Name:</label>\r\n        <div className=\"col-sm py-0\">\r\n          <input type=\"text\" className=\"form-control form-control-sm w-100 py-0\" value={name} onChange={ev => set_name(ev.target.value)}/>\r\n        </div>\r\n      </div>\r\n      <div className=\"form-group row mt-0 mb-0\">\r\n        <div className=\"col-sm-3 col-form-label py-0\">\r\n        <label className=\"mr-1\">Rule:</label>\r\n        <span className=\"\" data-toggle=\"tooltip\" data-placement=\"left\" data-html={true} title={tooltip}>\r\n          <i className=\"fas fa-question-circle\"></i>\r\n        </span>\r\n\r\n        </div>\r\n        <div className=\"col-sm py-0\">\r\n          <input type=\"text\" className={`form-control form-control-sm w-100 py-0 ${err_fmt}`} id=\"ca_string\" value={ca_string} onChange={ev => set_ca_string(ev.target.value)}/>\r\n          {errors && render_errors(errors)}\r\n        </div>\r\n      </div>\r\n    </form>\r\n  );\r\n\r\n  const actions = (\r\n    <div \r\n      className={`actions ${!show_actions && 'fade'}`} \r\n      onMouseOver={() => set_show_actions(true)}>\r\n      <button className=\"btn btn-circle btn-sm btn-warning\" role=\"button\" onClick={on_exit}><i className=\"fas fa-ban\"></i></button>\r\n      <button className=\"btn btn-circle btn-sm btn-success\" role=\"button\" onClick={on_submit}><i className=\"fas fa-check-circle\"></i></button>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div \r\n      onMouseEnter={() => set_show_actions(true)}\r\n      onMouseLeave={() => set_show_actions(false)}>\r\n      {form}\r\n      {actions}\r\n    </div>\r\n  )\r\n}","import React, { useState } from 'react';\r\nimport { useDispatch, useSelector } from 'react-redux';\r\n\r\nimport \"./Entry.css\";\r\nimport { select_entry, edit_entry, delete_entry } from '../../actions';\r\nimport { EntryEditor } from './EntryEditor';\r\n\r\n/**\r\n * Swap between a basic view and editable form \r\n */\r\nexport function Entry(props) {\r\n  const dispatch = useDispatch();\r\n\r\n  const entry = props.entry;\r\n  const {browser, index} = props;\r\n\r\n  // for editing\r\n  let [editing, set_editing] = useState(false);\r\n  let [errors, set_errors] = useState(undefined);\r\n\r\n  let [name, set_name] = useState(entry.name);\r\n  let [ca_string, set_ca_string] = useState(entry.description);\r\n\r\n  const on_submit = (name, ca_string) => {\r\n    dispatch(edit_entry(browser, index, name, ca_string, err => {\r\n      set_errors(err);\r\n      err ? set_editing(true) : set_editing(false);\r\n      if (!err) {\r\n        set_name(name);\r\n        set_ca_string(ca_string);\r\n      }\r\n    }))\r\n  }\r\n\r\n  const on_exit = () => {\r\n    set_editing(false);\r\n    set_errors(false);\r\n  }\r\n\r\n  const render_editable_body = () => (\r\n    <li className=\"list-group-item\">\r\n      <EntryEditor name={name} ca_string={ca_string} onSubmit={on_submit} onExit={on_exit} errors={errors}></EntryEditor>\r\n    </li>\r\n  )\r\n\r\n  const render_normal_body = () => (\r\n    <EntryView \r\n      browser={browser} index={index} \r\n      name={name} ca_string={ca_string}\r\n      actions={props.actions}\r\n      selected={props.selected}\r\n      onEdit={() => set_editing(true)}></EntryView>\r\n  );\r\n  \r\n  return editing ? render_editable_body() : render_normal_body();\r\n}\r\n\r\n/**\r\n * Render entry with controls for editing, deleting and copying \r\n */\r\nfunction EntryView(props) {\r\n  let dispatch = useDispatch();\r\n  let [show_actions, set_show_actions] = useState(false);\r\n  let [copy_success, set_copy_success] = useState(false);\r\n\r\n  const {browser, index} = props;\r\n  const {name, ca_string} = props;\r\n  const selected = props.selected;\r\n  const {del, copy, edit} = props.actions;\r\n  const onEdit = props.onEdit;\r\n\r\n\r\n  const on_select = ev => {\r\n    dispatch(select_entry(browser, index));\r\n    ev.preventDefault();\r\n  }\r\n  // base actions\r\n  const on_delete = ev => {\r\n    dispatch(delete_entry(browser, index));\r\n    ev.preventDefault();\r\n  }\r\n\r\n  const on_copy = ev => {\r\n    navigator.permissions.query({name: 'clipboard-write'}).then(res => {\r\n      if (res.state === 'granted' || res.state === 'prompt') {\r\n        navigator.clipboard.writeText(ca_string)\r\n          .then(() => set_copy_success(true));\r\n      }\r\n    });\r\n    ev.preventDefault();\r\n  }\r\n\r\n  const on_edit = ev => {\r\n    ev.preventDefault();\r\n    onEdit && onEdit();\r\n  }\r\n\r\n  const render_copy_tooltip = () => (\r\n    <div className={`tooltip copy-text ${copy_success ? 'show' : 'fade'}`} role=\"tooltip\">\r\n      <div className=\"tooltip-inner\">Copied {name}!</div>\r\n    </div>\r\n  );\r\n\r\n  const render_copy_button = () => ( \r\n    <div className=\"d-inline\">\r\n      <button className=\"btn btn-circle btn-sm btn-light\" role=\"button\" \r\n          onClick={on_copy} onMouseLeave={() => set_copy_success(false)}>\r\n        <span className=\"icon text-gray-600\">\r\n          <i className=\"fas fa-copy\"></i>\r\n        </span>\r\n      </button>\r\n      {render_copy_tooltip()}\r\n    </div>\r\n  );\r\n\r\n\r\n  const render_actions = () => (\r\n    <div className={`actions ${!show_actions && 'fade'}`} onMouseOver={() => set_show_actions(true)}>\r\n      {copy && render_copy_button()}\r\n      {del && <button className=\"btn btn-circle btn-sm btn-danger\" role=\"button\" onClick={on_delete}><i className=\"fas fa-trash\"></i></button>}\r\n      {edit && <button className=\"btn btn-circle btn-sm btn-primary\" role=\"button\" onClick={on_edit}><i className=\"fas fa-edit\"></i></button>}\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <li className={`list-group-item ${selected ? 'active' : ''}`}>\r\n      <div \r\n        onMouseEnter={() => set_show_actions(true)}\r\n        onMouseLeave={() => set_show_actions(false)}>\r\n        <div onClick={on_select}>\r\n          <div>Name: {name}</div>\r\n          <div>Rule: {ca_string}</div>\r\n        </div>\r\n        {render_actions()}\r\n      </div>\r\n    </li>\r\n  );\r\n}\r\n","import React, { useState } from 'react';\r\n\r\nimport { useDispatch } from 'react-redux';\r\nimport { EntryEditor } from './EntryEditor';\r\nimport { create_entry } from '../../actions';\r\n\r\nexport function AddButton() {\r\n  let dispatch = useDispatch();\r\n  let [editing, set_editing] = useState(false);\r\n  let [errors, set_errors] = useState(false);\r\n\r\n  const render_add_button = () => (\r\n    <li className=\"list-group-item\" style={{textAlign:'center'}}>\r\n      <button className=\"btn btn-circle btn-md btn-secondary shadow\" onClick={() => set_editing(true)}>\r\n        <span className=\"icon text-white-600 m-0\">\r\n          <i className=\"fas fa-plus\"></i>\r\n        </span>\r\n      </button>\r\n    </li>\r\n  );\r\n\r\n  const on_submit = (name, ca_string) => {\r\n    dispatch(create_entry(name, ca_string, err => {\r\n      set_errors(err);\r\n      err ? set_editing(true) : set_editing(false);\r\n    }));\r\n  }\r\n\r\n  const on_exit = () => {\r\n    set_editing(false);\r\n    set_errors(false);\r\n  }\r\n\r\n  const render_form = () => (\r\n    <li className=\"list-group-item\">\r\n      <EntryEditor errors={errors} onSubmit={on_submit} onExit={on_exit}></EntryEditor>\r\n    </li>\r\n  );\r\n\r\n  return editing ? render_form() : render_add_button()\r\n}","import React, { useState } from 'react';\r\n\r\nimport { useSelector } from 'react-redux';\r\nimport { Entry } from './Entry';\r\nimport { AddButton } from './AddButton';\r\n\r\nexport function EntryBrowser() {\r\n  const selected_browser_key = useSelector(state => state.entry_browser.current_browser_key);\r\n  const selected_index = useSelector(state => state.entry_browser.selected_browser.current_index);\r\n\r\n  let [browser_key, set_browser_key] = useState(selected_browser_key);\r\n\r\n  const browsers = useSelector(state => state.entry_browser.browsers);\r\n  const entries = useSelector(state => state.entry_browser.get_entries(browser_key));\r\n\r\n  let is_user = (browser_key === 'User');\r\n\r\n  let browser_keys = [];\r\n  for (let key in browsers) {\r\n    browser_keys.push(key);\r\n  }\r\n\r\n  function render_rule_items() { \r\n    return entries.map((e, i) => {\r\n      let props = {\r\n        entry: e, \r\n        browser: browser_key, index: i,\r\n        actions: {del: is_user, copy: true, edit: is_user},\r\n        selected: i === selected_index && browser_key === selected_browser_key,\r\n      }\r\n      let index = e.id === undefined ? i : e.id;\r\n      return <Entry {...props} key={`${browser_key}_${index}`}></Entry>\r\n    });\r\n  }\r\n\r\n  const render_controls = (\r\n    <div className=\"d-flex flex-row my-0 py-0\">\r\n      <div className=\"btn-group py-0 my-0\">\r\n        {browser_keys.map((e, i) => { \r\n          let selected = e === browser_key;\r\n          return (\r\n            <button \r\n              className={`btn btn-sm ${selected ? 'btn-primary' : 'btn-outline-secondary'}`} \r\n              key={i} onClick={() => set_browser_key(e)}>{e}</button>\r\n          )\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"card shadow mb-2\">\r\n      <div className=\"card-header py-2 d-flex flex-row align-items-center justify-content-between\">\r\n        <h6 className=\"m-0 font-weight-bold text-primary\">Rules</h6>\r\n        {render_controls}\r\n      </div>\r\n      <div className=\"collapse show\" id=\"collapseRulesBrowser\">\r\n        <ul className=\"list-group\">\r\n          {render_rule_items()}\r\n        </ul>\r\n        {is_user && <AddButton></AddButton>}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import React from 'react';\r\n\r\nexport function Help(props) {\r\n  return (\r\n    <span className=\"\" data-toggle=\"tooltip\" data-placement=\"left\" data-html={true} title={props.text}>\r\n      <i className=\"fas fa-question-circle\"></i>\r\n    </span>\r\n  )\r\n}","import React from 'react';\r\nimport { useState } from 'react';\r\nimport \"./ColorPicker.css\";\r\nimport { ChromePicker } from 'react-color';\r\n\r\nexport function ColorPicker({color, valueChanged}) {\r\n    let [show_picker, set_show_picker] = useState(false);\r\n    let rgba = {r: color[0], g: color[1], b: color[2], a:1};\r\n\r\n    const on_click = () => set_show_picker(!show_picker);\r\n    const on_change = colour => {\r\n        let rgb = colour.rgb;\r\n        valueChanged([rgb.r, rgb.g, rgb.b]);\r\n    } \r\n\r\n    const on_close = () => set_show_picker(false);\r\n\r\n    return (\r\n        <div>\r\n            <div className=\"swatch\" onClick={on_click}>\r\n                <div className=\"color-display\" style={{background: `rgba(${rgba.r}, ${rgba.g}, ${rgba.b}, ${rgba.a})`}}></div>\r\n            </div>\r\n            {show_picker && \r\n            <div className=\"popover\">\r\n                <div className=\"cover\" onClick={on_close}/>\r\n                <ChromePicker color={rgba} onChange={on_change} disableAlpha={true}></ChromePicker>\r\n            </div>}\r\n\r\n        </div>\r\n    )\r\n}","import React from 'react';\r\nimport { Help } from './Help';\r\nimport { ColorPicker } from './ColorPicker';\r\n\r\nexport function RenderAdjustableValue(adjustable, key, name, valueChanged) {\r\n  let type = adjustable.type;\r\n  switch (type) {\r\n    case 'slider':\r\n      return SliderView(adjustable, key, name, valueChanged);\r\n    case 'toggle':\r\n      return ToggleView(adjustable, key, name, valueChanged);\r\n    case 'dropdown':\r\n      return DropdownView(adjustable, key, name, valueChanged);\r\n    case 'color':\r\n      return ColorView(adjustable, key, name, valueChanged);\r\n    default:\r\n      return;\r\n  }\r\n}\r\n\r\nfunction SliderView(slider, key, name, valueChanged) {\r\n  let step = (slider.max-slider.min)/100.0;\r\n  return (\r\n    <div className='form-inline' key={key}>\r\n      <div className=\"row w-100\">\r\n        <div className=\"col-sm\">{name}: {slider.value.toFixed(2)}</div>\r\n        {slider.help && <div className=\"col-sm-1 text-right\"><Help text={slider.help}></Help></div>}\r\n      </div>\r\n      <input \r\n        className='form-control-range' type='range' \r\n        min={slider.min} max={slider.max} value={slider.value} step={step}\r\n        onChange={ev => valueChanged(Number(ev.target.value))}></input> \r\n    </div>\r\n );\r\n}\r\n\r\nfunction ToggleView(toggle, key, name, valueChanged) {\r\n  return (\r\n    <div className=\"row w-100\">\r\n      <div className=\"col-sm\">\r\n        <div className='form-check' key={key}>\r\n          <input \r\n            type='checkbox' className='form-check-input'\r\n            checked={toggle.value}\r\n            onChange={ev => valueChanged(ev.target.checked)}></input>\r\n          <label className='form-check-label'>{name}</label>\r\n        </div>\r\n      </div>\r\n      {toggle.help && <div className=\"col-sm-1 text-right\"><Help text={toggle.help}></Help></div>}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction DropdownView(dropdown, key, name, valueChanged) {\r\n  let onChange = ev => valueChanged(Number(ev.target.value));\r\n  return (\r\n    <div className=\"row w-100\">\r\n      <div className=\"col-sm\">\r\n        <div className='form-inline' key={key}>\r\n          <label className='mr-2'>{name} </label>\r\n          <select className='custom-select custom-select-sm' value={dropdown.value} onChange={onChange}>\r\n            {dropdown.options.map((option, i) => (\r\n              <option value={i} key={`${name}_${key}_${i}`}>{option}</option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n      </div>\r\n      {dropdown.help && <div className=\"col-sm-1 text-right\"><Help text={dropdown.help}></Help></div>}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ColorView(color, key, name, valueChange) {\r\n  return (\r\n    <div className=\"row w-100\" key={key}>\r\n      <div className=\"form-inline col-sm\">\r\n          <ColorPicker color={color.value} valueChanged={valueChange}></ColorPicker>\r\n          <label className=\"ml-1\">{name}</label>\r\n      </div>\r\n      {color.help && <div className=\"col-sm-1 text-right\"><Help text={color.help}></Help></div>}\r\n    </div>\r\n  );\r\n}","import React from 'react';\r\nimport { useSelector, useDispatch } from 'react-redux';\r\n\r\nimport { RenderAdjustableValue } from '../util/AdjustableValueViews';\r\n\r\nimport { show_border, show_render, set_background_colour, set_border_colour } from '../actions';\r\n\r\nexport function BorderControls() {\r\n  const dispatch = useDispatch();\r\n  const border_checkbox = useSelector(state => state.app.show_border);\r\n  const render_checkbox = useSelector(state => state.app.show_render);\r\n  const background_colour = useSelector(state => state.app.background_colour);\r\n  const border_colour = useSelector(state => state.app.border.colour);\r\n  // force redux to acknowledge when this is changed\r\n  let _ = useSelector(state => state.app.show_border.value);\r\n  _ = useSelector(state => state.app.show_render.value);\r\n  _ = useSelector(state => state.app.background_colour.value);\r\n  _ = useSelector(state => state.app.border.colour.value);\r\n\r\n  return (\r\n    <div>\r\n      {RenderAdjustableValue(border_checkbox, 0, 'Show Border', value => {\r\n        dispatch(show_border(value));\r\n      })}\r\n      {RenderAdjustableValue(render_checkbox, 1, 'Show Render', value => {\r\n        dispatch(show_render(value));\r\n      })}\r\n      {RenderAdjustableValue(background_colour, 2, 'Background Colour', value => {\r\n        dispatch(set_background_colour(value));\r\n      })}\r\n      {RenderAdjustableValue(border_colour, 2, 'Border Colour', value => {\r\n        dispatch(set_border_colour(value));\r\n      })}\r\n    </div>\r\n  )\r\n}","import React from 'react';\r\nimport { useSelector, useDispatch } from 'react-redux';\r\nimport { RenderAdjustableValue } from '../util/AdjustableValueViews';\r\nimport { BorderControls } from './BorderControls';\r\nimport { update_shader_params, select_renderer } from '../actions';\r\n\r\nexport function ShaderMenu() {\r\n  const dispatch = useDispatch();\r\n  const renderer_type = useSelector(state => state.shader_manager.renderer_type);\r\n  const current_renderer_type = useSelector(state => state.shader_manager.renderer_type.value);\r\n\r\n  const card_body = (\r\n    <div>\r\n      <form className='form-inline'>\r\n        {RenderAdjustableValue(renderer_type, 0, 'Renderer', value => {\r\n          dispatch(select_renderer(value));\r\n        })}\r\n      </form>\r\n      <BorderControls></BorderControls>\r\n      <hr></hr>\r\n      <ShaderSettings></ShaderSettings>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"card shadow mb-2\">\r\n      <a href=\"#collapseGraphicsMenu\" className=\"card-header d-block\" data-toggle=\"collapse\" role=\"button\" aria-expanded=\"true\" aria-controls=\"collapseGraphicsMenu\">\r\n        <h6 className=\"m-0 font-weight-bold text-primary\">Graphics</h6>\r\n      </a>\r\n      <div className=\"collapse show\" id=\"collapseGraphicsMenu\">\r\n        <div className=\"card-body\">\r\n          {card_body}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ShaderSettings() {\r\n  const dispatch = useDispatch();\r\n  const params = useSelector(state => state.shader_manager.params);\r\n\r\n  return (\r\n    <form>{Object.entries(params).map(([name, param], index) => {\r\n      return RenderAdjustableValue(param, index, name, value => {\r\n        let data = {};\r\n        data[name] = value;\r\n        dispatch(update_shader_params(data)); \r\n      })\r\n    })}</form>\r\n  );\r\n}","import React, { useState } from 'react';\r\nimport { vec3 } from 'gl-matrix';\r\nimport { useDispatch, useSelector } from 'react-redux';\r\nimport { set_size } from '../actions';\r\n\r\nexport function SizeChanger() {\r\n  const dispatch = useDispatch();\r\n  const app_size = useSelector(state => state.app.size);\r\n  let [x, set_x] = useState(app_size[0]);\r\n  let [y, set_y] = useState(app_size[1]);\r\n  let [z, set_z] = useState(app_size[2]);\r\n\r\n  const max_size = 1000;\r\n  const min_size = 1;\r\n\r\n  function clamp(val) {\r\n    let clamped = Number(val);\r\n    clamped = Math.max(clamped, min_size);\r\n    clamped = Math.min(clamped, max_size);\r\n    return clamped;\r\n  }\r\n\r\n  function on_size_change(event) {\r\n    let X = clamp(x);\r\n    let Y = clamp(y);\r\n    let Z = clamp(z);\r\n    set_x(X);\r\n    set_y(Y);\r\n    set_z(Z);\r\n    let size = vec3.fromValues(X, Y, Z);\r\n    dispatch(set_size(size));\r\n    event.preventDefault();\r\n  }\r\n\r\n  const size_changer_form = (\r\n    <form onSubmit={(event) => on_size_change(event)}>\r\n      <div className=\"input-group mb-0\">\r\n        <input type=\"number\" value={x} max={max_size} min={min_size} onChange={ev => set_x(ev.target.value)}></input> \r\n        <input type=\"number\" value={y} max={max_size} min={min_size} onChange={ev => set_y(ev.target.value)}></input> \r\n        <input type=\"number\" value={z} max={max_size} min={min_size} onChange={ev => set_z(ev.target.value)}></input> \r\n        <div className=\"input-group-append\">\r\n          <button type=\"submit\" className='btn btn-primary btn-sm' role=\"button\">Apply</button>\r\n        </div>\r\n      </div>\r\n    </form>\r\n  );\r\n\r\n  return (\r\n    <div className=\"card shadow mb-2\">\r\n      <a href=\"#collapseSizeChanger\" className=\"card-header d-block\" data-toggle=\"collapse\" role=\"button\" aria-expanded=\"true\" aria-controls=\"collapseSizeChanger\">\r\n        <h6 className=\"m-0 font-weight-bold text-primary\">Size Controls</h6>\r\n      </a>\r\n      <div className=\"collapse show\" id=\"collapseSizeChanger\">\r\n        <div className=\"card-body\">\r\n          {size_changer_form}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}","import React from 'react';\r\nimport { useSelector } from 'react-redux';\r\n\r\nexport function Statistics() {\r\n  const completed_blocks = useSelector(state => state.stats.data.completed_blocks);\r\n  const total_blocks = useSelector(state => state.stats.data.total_blocks);\r\n  const frame_time = useSelector(state => state.stats.data.frame_time);\r\n  const total_steps = useSelector(state => state.stats.data.total_steps);\r\n  const texture_data_update = useSelector(state => state.stats.data.texture_data_update);\r\n  const texture_data_upload = useSelector(state => state.stats.data.texture_data_upload);\r\n  const draw_time = useSelector(state => state.stats.data.draw_time);\r\n\r\n  let progress = 0;\r\n  if (total_blocks > 0) {\r\n    progress = completed_blocks/total_blocks * 100;\r\n  }\r\n\r\n  const stats = (\r\n    <div>\r\n      <div className=\"row\">\r\n        <div className=\"col\">\r\n          <div>Total Steps: {total_steps}</div>\r\n          <div>Frame Time (ms): {frame_time.toFixed(2)}</div>\r\n          <div>Draw Time (ms): {draw_time.toFixed(2)}</div>\r\n        </div>\r\n        <div className=\"col\">\r\n          <div>Tex Update (ms): {texture_data_update.toFixed(2)}</div>\r\n          <div>Tex Upload (ms): {texture_data_upload.toFixed(2)}</div>\r\n        </div>\r\n      </div>\r\n      <div className=\"row\">\r\n        <div className=\"col\">Progress: {completed_blocks}/{total_blocks} ({progress.toFixed(2)}%)</div>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"card shadow\">\r\n      <a href=\"#collapseStatsMenu\" className=\"card-header d-block\" data-toggle=\"collapse\" role=\"button\" aria-expanded=\"true\" aria-controls=\"collapseStatsMenu\">\r\n        <h6 className=\"m-0 font-weight-bold text-primary\">Statistics</h6>\r\n      </a>\r\n      <div className=\"collapse show\" id=\"collapseStatsMenu\">\r\n        <div className=\"card-body\">\r\n          {stats}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}","import React from 'react';\r\nimport { useSelector, useDispatch } from 'react-redux'\r\nimport { RenderAdjustableValue } from '../util/AdjustableValueViews';\r\nimport { update_randomiser, select_randomiser } from '../actions';\r\nimport { Help } from '../util/Help';\r\n\r\nexport function RandomiserMenu() {\r\n  const dispatch = useDispatch();\r\n  let current_index = useSelector(state => state.randomiser.current_index);\r\n  let entries = useSelector(state => state.randomiser.entries);\r\n\r\n  function on_select_randomiser(event) {\r\n    let index = event.target.value;\r\n    dispatch(select_randomiser(index));\r\n  }\r\n\r\n  const randomiser_options = entries.map((e, i) => {\r\n    return (<option value={i} key={i}>{e.type}</option>);\r\n  });\r\n\r\n  const card_body = (\r\n    <div>\r\n      <div className=\"row w-100\">\r\n        <div className=\"col-sm\">\r\n          <div className='form-inline'>\r\n            <label className='mr-2'>Randomiser</label>\r\n            <select className='custom-select custom-select-sm' value={current_index} onChange={on_select_randomiser}>\r\n              {randomiser_options}\r\n            </select>\r\n          </div>\r\n        </div>\r\n        <div className=\"col-sm-1 text-right\"><Help text={\"Type of randomiser to use\"}></Help></div>\r\n      </div>\r\n      <hr></hr>\r\n      <SeedCrystalEditor></SeedCrystalEditor>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"card shadow mb-2\">\r\n      <a href=\"#collapseRandomiserMenu\" className=\"card-header d-block\" data-toggle=\"collapse\" role=\"button\" aria-expanded=\"true\" aria-controls=\"collapseRandomiserMenu\">\r\n        <h6 className=\"m-0 font-weight-bold text-primary\">Randomiser</h6>\r\n      </a>\r\n      <div className=\"collapse show\" id=\"collapseRandomiserMenu\">\r\n        <div className=\"card-body\">\r\n          {card_body}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport function SeedCrystalEditor() {\r\n  const dispatch = useDispatch();\r\n  let params = useSelector(state => state.randomiser.current_randomiser.params);\r\n\r\n  function change_param(name, value) {\r\n    dispatch(update_randomiser(name, value));\r\n  }\r\n\r\n  let param_options = Object\r\n    .entries(params)\r\n    .map(([name, param], index) => {\r\n      return RenderAdjustableValue(param, index, name, value => {\r\n        change_param(name, value);\r\n      })\r\n    });\r\n\r\n  return (\r\n    <form>\r\n      {param_options}\r\n    </form>\r\n  );\r\n}","import React, { useState } from 'react';\r\n\r\nimport { createStore, applyMiddleware, compose } from 'redux';\r\nimport { create_preinit_reducer } from './ui/reducers';\r\nimport { Provider, useSelector } from 'react-redux';\r\nimport thunk from 'redux-thunk';\r\n\r\nimport { SimulationView } from './ui/components/SimulationView/SimulationView';\r\nimport { EntryBrowser } from './ui/components/EntryBrowser/EntryBrowser';\r\nimport { ShaderMenu } from './ui/components/ShaderMenu';\r\nimport { SizeChanger } from './ui/components/SizeChanger';\r\nimport { Statistics } from './ui/components/Statistics';\r\nimport { RandomiserMenu } from './ui/components/Randomiser';\r\n\r\nexport class App extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.store = createStore(\r\n      create_preinit_reducer(),\r\n      compose(\r\n        applyMiddleware(thunk),\r\n        // window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__(),\r\n      )\r\n    );\r\n\r\n    this.canvas = React.createRef();\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <Provider store={this.store}>\r\n        <Main canvas={this.canvas}></Main>\r\n      </Provider>\r\n    );\r\n  }\r\n\r\n}\r\n\r\nfunction Main(props) {\r\n  const app = useSelector(store => store.app);\r\n  const fullscreen = useSelector(store => store.gui.fullscreen);\r\n  const gui = useSelector(store => store.gui);\r\n  \r\n  function render_left_panel() {\r\n    return (\r\n      <div className={`col-sm-3 overflow-auto vh-100 ${fullscreen && 'd-none'}`}>\r\n        <SizeChanger></SizeChanger>\r\n        <ShaderMenu></ShaderMenu>\r\n        <RandomiserMenu></RandomiserMenu>\r\n        <Statistics></Statistics>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  function render_right_panel() {\r\n    return (\r\n      <div className={`col-sm-3 overflow-auto vh-100 ${fullscreen && 'd-none'}`}>\r\n        <EntryBrowser></EntryBrowser>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const canvas = <SimulationView canvas={props.canvas}></SimulationView>;\r\n\r\n  return (\r\n    <div className=\"vh-100 vw-100\">\r\n      <div className=\"row px-0 mx-0\">\r\n        {app && render_left_panel()}\r\n        <div className=\"col vh-100 mx-0 px-0\">{canvas}</div>\r\n        {app && render_right_panel()}\r\n      </div>\r\n    </div>\r\n  );\r\n}","// This optional code is used to register a service worker.\r\n// register() is not called by default.\r\n\r\n// This lets the app load faster on subsequent visits in production, and gives\r\n// it offline capabilities. However, it also means that developers (and users)\r\n// will only see deployed updates on subsequent visits to a page, after all the\r\n// existing tabs open on the page have been closed, since previously cached\r\n// resources are updated in the background.\r\n\r\n// To learn more about the benefits of this model and instructions on how to\r\n// opt-in, read https://bit.ly/CRA-PWA\r\n\r\nconst isLocalhost = Boolean(\r\n  window.location.hostname === 'localhost' ||\r\n    // [::1] is the IPv6 localhost address.\r\n    window.location.hostname === '[::1]' ||\r\n    // 127.0.0.0/8 are considered localhost for IPv4.\r\n    window.location.hostname.match(\r\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\r\n    )\r\n);\r\n\r\nexport function register(config) {\r\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\r\n    // The URL constructor is available in all browsers that support SW.\r\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\r\n    if (publicUrl.origin !== window.location.origin) {\r\n      // Our service worker won't work if PUBLIC_URL is on a different origin\r\n      // from what our page is served on. This might happen if a CDN is used to\r\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\r\n      return;\r\n    }\r\n\r\n    window.addEventListener('load', () => {\r\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\r\n\r\n      if (isLocalhost) {\r\n        // This is running on localhost. Let's check if a service worker still exists or not.\r\n        checkValidServiceWorker(swUrl, config);\r\n\r\n        // Add some additional logging to localhost, pointing developers to the\r\n        // service worker/PWA documentation.\r\n        navigator.serviceWorker.ready.then(() => {\r\n          console.log(\r\n            'This web app is being served cache-first by a service ' +\r\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\r\n          );\r\n        });\r\n      } else {\r\n        // Is not localhost. Just register service worker\r\n        registerValidSW(swUrl, config);\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nfunction registerValidSW(swUrl, config) {\r\n  navigator.serviceWorker\r\n    .register(swUrl)\r\n    .then(registration => {\r\n      registration.onupdatefound = () => {\r\n        const installingWorker = registration.installing;\r\n        if (installingWorker == null) {\r\n          return;\r\n        }\r\n        installingWorker.onstatechange = () => {\r\n          if (installingWorker.state === 'installed') {\r\n            if (navigator.serviceWorker.controller) {\r\n              // At this point, the updated precached content has been fetched,\r\n              // but the previous service worker will still serve the older\r\n              // content until all client tabs are closed.\r\n              console.log(\r\n                'New content is available and will be used when all ' +\r\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\r\n              );\r\n\r\n              // Execute callback\r\n              if (config && config.onUpdate) {\r\n                config.onUpdate(registration);\r\n              }\r\n            } else {\r\n              // At this point, everything has been precached.\r\n              // It's the perfect time to display a\r\n              // \"Content is cached for offline use.\" message.\r\n              console.log('Content is cached for offline use.');\r\n\r\n              // Execute callback\r\n              if (config && config.onSuccess) {\r\n                config.onSuccess(registration);\r\n              }\r\n            }\r\n          }\r\n        };\r\n      };\r\n    })\r\n    .catch(error => {\r\n      console.error('Error during service worker registration:', error);\r\n    });\r\n}\r\n\r\nfunction checkValidServiceWorker(swUrl, config) {\r\n  // Check if the service worker can be found. If it can't reload the page.\r\n  fetch(swUrl, {\r\n    headers: { 'Service-Worker': 'script' },\r\n  })\r\n    .then(response => {\r\n      // Ensure service worker exists, and that we really are getting a JS file.\r\n      const contentType = response.headers.get('content-type');\r\n      if (\r\n        response.status === 404 ||\r\n        (contentType != null && contentType.indexOf('javascript') === -1)\r\n      ) {\r\n        // No service worker found. Probably a different app. Reload the page.\r\n        navigator.serviceWorker.ready.then(registration => {\r\n          registration.unregister().then(() => {\r\n            window.location.reload();\r\n          });\r\n        });\r\n      } else {\r\n        // Service worker found. Proceed as normal.\r\n        registerValidSW(swUrl, config);\r\n      }\r\n    })\r\n    .catch(() => {\r\n      console.log(\r\n        'No internet connection found. App is running in offline mode.'\r\n      );\r\n    });\r\n}\r\n\r\nexport function unregister() {\r\n  if ('serviceWorker' in navigator) {\r\n    navigator.serviceWorker.ready\r\n      .then(registration => {\r\n        registration.unregister();\r\n      })\r\n      .catch(error => {\r\n        console.error(error.message);\r\n      });\r\n  }\r\n}\r\n","import React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport { App } from './App';\r\nimport * as serviceWorker from './serviceWorker';\r\n\r\nReactDOM.render(\r\n  <App></App>,\r\n  document.getElementById('root')\r\n);\r\n\r\nserviceWorker.unregister();\r\n// serviceWorker.register();"],"sourceRoot":""}